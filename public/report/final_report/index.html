<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/website/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=website/livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Development of A Battery Management System for AUV4.5 | AUV Battery Management System</title>
<meta name="keywords" content="">
<meta name="description" content="This report documents the work done on developing the Battery Management System for an Autonomous Underwater Vehicle (AUV4.5) in preparation for RoboSub 2025.">
<meta name="author" content="Teoh Xu En">
<link rel="canonical" href="http://localhost:1313/website/report/final_report/">
<link crossorigin="anonymous" href="/website/assets/css/stylesheet.5e7937a63ee023e710c118bb90ce77a5642898bb8f3ab5adb8ca751deaa6714f.css" integrity="sha256-Xnk3pj7gI&#43;cQwRi7kM53pWQomLuPOrWtuMp1HeqmcU8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/website/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/website/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/website/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/website/apple-touch-icon.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/website/report/final_report/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript><meta property="og:title" content="Development of A Battery Management System for AUV4.5" />
<meta property="og:description" content="This report documents the work done on developing the Battery Management System for an Autonomous Underwater Vehicle (AUV4.5) in preparation for RoboSub 2025." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/website/report/final_report/" /><meta property="article:section" content="report" />
<meta property="article:published_time" content="2025-04-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2025-04-04T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Development of A Battery Management System for AUV4.5"/>
<meta name="twitter:description" content="This report documents the work done on developing the Battery Management System for an Autonomous Underwater Vehicle (AUV4.5) in preparation for RoboSub 2025."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Report",
      "item": "http://localhost:1313/website/report/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Development of A Battery Management System for AUV4.5",
      "item": "http://localhost:1313/website/report/final_report/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Development of A Battery Management System for AUV4.5",
  "name": "Development of A Battery Management System for AUV4.5",
  "description": "This report documents the work done on developing the Battery Management System for an Autonomous Underwater Vehicle (AUV4.5) in preparation for RoboSub 2025.",
  "keywords": [
    
  ],
  "articleBody": "Acknowledgements Firstly, I would like to thank Team Bumblebee for the opportunity to work on this project.This project would not have been possible without the support of the many dedicated Bumblebee Members. I am especially grateful to Chai Zi Yang and Tan Chern Lin Justin for taking the time to review my PCB designs, Chen Jia Wei for spending countless hours troubleshooting with me and Marvin Pranajaya for his valuable advice on the Power Management Board. I would also like to thank Guk Yi Siong for assisting with the collection of power consumption data during in-water testing and Ananya Agarwal for her work on the Battery Hulls.\nAdditionally, I would like to express my gratitude to Parker Schless from Cornell AUV, for generously taking the time to address my technical queries on the implementation of the BQ40Z50 chip.\nI also wish to acknowledge the support provided by the NUS College of Engineering, particularly Ms Annie, Mr Patrick, and Mr Graham from the Engineering Design and Innovation Centre. I would also like to thank Prof Goh Cher Hiang and Mr Eugene Ee for taking the time to review my project and provide valuable advice.\nFinally, I am deeply grateful to my family for their unwavering patience and support through my journey in Team Bumblebee.\nList of Common Acronyms Acronym Definition ASV Autonomous Surface Vessel AUV Autonomous Underwater Vehicle BBAS Bumblebee Autonomous Systems BCB Battery Charging Box BTB Battery Telemetry Board CAN Controller Area Network OCS Operator Control Station PCB Printed Circuit Board PMB Power Monitoring Board SoC State of Charge 1. Summary This project focuses on developing a Power Monitoring Board for the upcoming Autonomous Underwater Vehicle, AUV4.5. The PMB is a critical component of the vehicle’s electrical system, designed to interface the battery reliably and safely with the AUV.\nThe new PMB introduces key features such as accurate state-of-charge tracking and in-hull firmware upgrades while maintaining backward compatibility with AUV4.1. Additionally, a new Battery Telemetry Board (BTB) will be integrated into the Battery Charging Box (BCB) enabling real-time monitoring, wireless data upload and automated fault detection during battery charging.\n2. Problem Background 2.1 Introduction Bumblebee Autonomous Systems (BBAS) is a student-led project team that designs and builds Autonomous Underwater Vehicles (AUVs) for the annual RoboSub competition. Following lessons learned from AUV4.1’s participation in RoboSub 2023 (Figure 1), the team is concurrently developing AUV4.5 for RoboSub 2025 and AUV5.0 for RoboSub 2026 (Table 1).\nFigure 1: AUV4.1 at RoboSub 2023 Competition Vehicles Deployed RoboSub 2023 AUV4.1 RoboSub 2025 AUV4.5 RoboSub 2026 AUV4.5 and AUV5.0 Table 1: AUV Deployments in RoboSub Competitions AUV4.5 retains the same hull design as AUV4.1 but features a newly developed electrical and software subsystem. This new electrical subsystem is designed to be mechanically compatible with the existing AUV4.1 hull while also serving as the baseline for AUV5.0.\n2.2 Current System The current power system for the AUVs comprises two main components, the Battery Hull (Figure 2) and the Battery Charging Box (BCB). Each Battery Hull houses a Power Monitoring Board (PMB) and a LiPo battery.\nThe PMB (Figure 3) monitors and reports key telemetry data, such as the battery’s voltage, current, battery hull’s temperature and pressure, both on the screen and via the CAN Bus. Two such hulls are connected to power to the AUV. The waterproof designs allows for quick battery swap during pool test by eliminating the need to unseal the main vehicle hull.\nFigure 2: Metal 3D-Printed Battery Hull Figure 3: AUV4.1’s Power Monitoring Board Figure 4: Assembled Battery Hull The BCB (Figure 5) comprises an AC-DC power supply and a LiPo charger. It includes connectors that interface directly with the battery hull, allowing the battery to be charged without removing it from the hull.\nFigure 5: Battery Charging Box 2.3 Limitations of Current System Deploying the current system at RoboSub 2023 identified several challenges.\n2.3.1 Challenges with Battery Hull Sealing The limited space within the battery hull and the need for a watertight seal, makes sealing and unsealing the hull a challenging and time-consuming process. Without error, unsealing takes 2 members approximately 10 minutes, while resealing requires another 15 minutes. However, the confined space often results in disconnected cables during assembly, further complicating the process. This overhead increase downtime and the risk of assembly errors.\nFigure 6: Two Man Team Attempting to Seal a Battery Hull at RoboSub 2023 2.3.2 Limited Capabilities of Battery Fuel Gauge The PMB currently uses BQ34110 chip as a gas gauge, which is designed for rarely discharged applications and lacks essential protection features [1], reducing the AUV’s reliability. Furthermore, the battery gauging capability was also not used, leading the team to rely on voltage readings to estimate the capacity of the battery. This method is inaccurate as the battery voltage remains relatively constant over a significant portion of the discharge cycle, while the actual capacity decreases rapidly (Figure 7). To err on the side of caution, the pool test is ended when the voltage drops to the nominal level, further limiting the AUV’s runtime.\nFigure 7: Typical Li-Ion Discharge Voltage Curve [2] 2.3.3 Challenges with Tracking Battery Hull’s Pressure and Temperature During assembly, the battery hull is pressurised. Monitoring changes in pressure and temperature can alert the team to potential leaks. Currently, this tracking is done manually and only when a leak is suspected. his reactive approach limits the availability of historical data. Manual tracking can lead to missing data or recording error, reducing the effectiveness of leak detection.\nFigure 8: Manually Logging Battery’s Hull and Temperature on the Battery Hull’s Lid Figure 9: Manually Logging Battery’s Hull and Temperature on Excel 2.4 Problem Analysis The limitations in the current system can be split into three overarching themes: poor user operability, limited runtime and reduced reliability. These themes and their associated limitations are summarised in Table 1.\nCategory\rLimitations\rPoor User Operability\rChallenges with Battery Hull Sealing\rChallenges with Tracking Battery Hull’s Pressure and Temperature\rLimited Run Time\rLimitation of Battery Fuel Gauge\rChallenges with Battery Hull Sealing\rPoor Reliability\rLimitation of Battery Fuel Gauge\rChallenges with Tracking Battery Hull’s Pressure and Temperature\rTable 2: Categorisation of System Limitations Poor user operability increases the likelihood of mistakes at competition, especially under time constraints or operator fatigue. Furthermore, limited run time can lead to less testing opportunities and ultimately impacting competition performance (Table 2, Table 3). Finally, poor reliability increases the risk of mid-run failures or unplanned maintenance, leading to increased downtime.\nRobotX 2022 RobotX 2024 Testing Time in Singapore 200 Hours 330 Hours Final Score (adjusted) 1450 4450 Table 3: Table of Competition Results and Testing Time in Singapore Team Final Score Testing Time NUS 4450 49 Hours KMOU 2900 28 Hours ERAU 2250 33 Hours Inspiration 1600 25 Hours NTU 1050 17 Hours Table 4: Comparison of Final Score and Testing Time at RobotX 2024 3. Project Goal As a competition team, the primary objective is to maximise vehicle performance at RoboSub. By enhancing user operability and ensuring safe operation, the PMB directly contributes to system reliability, allowing for more in-water testing, and ultimately better competition performance.\nThe project goal can be summarised as:\nTo develop a battery management system that enhances user operability and workflow, ensures safe operation, and improves the AUV’s overall reliability and performance.\r3.1.1 Project Sub Goals Hence, a three-Pronged approach wass used to guide the development of the PMB, with each sub-goal detailed in its respective section.\nSub Goals Section Number Enhance User Operability and Work Flow Section 7 Improve Safety and Reliability Section 8 Improve AUV Performance Section 6 Table 5: Sub Goals and Corresponding Report Section 4. Design Considerations 4.1 Backward Compatibility As outlined in Section 2.1, AUV4.5 has the same mechanical structure as AUV4.1. As such, the new PMB must remain mechanically and electrically compatible with the AUV4.1 battery hull. This backward compatibility ensures minimal modification to the existing support infrastructure when using the new PMB. Furthermore, designing to meet AUV4.1’s specifications would also ensures forward compatibility with AUV5.0. This approach enables component reuse across AUV4.1, AUV4.5 and AUV5.0, reducing the need for custom variants and lowering the manufacturing cost by leveraging economies of scale.\nTo maintain backwards compatibility, the following constraints were identified.\nCharacteristics Constraints Dimensions The PMB and battery must fit within a 192mm x 77.5mm x 44mm volume of the AUV4.1 battery hull. Electrical Interface Existing connectors for power delivery and charging must be retained. Table 6: Design Constraints for Backward Compatibility 4.2 Functional Requirements In addition to physical compatibility, the PMB must meet or exceed the technical performance of its predecessor. The following functional requirements were defined to ensure the board can support AUV4.1, AUV4.5 and AUV5.0.\nTechnical Capabilities Specifications Voltage Output 14.8V to 16.8V (4S) Continuous Current 40A Communication Protocol CAN2.0 Telemetry Voltage, Current, Internal Pressure, Internal Temperature displayed on the screen Table 7: Core Functional Requirements for PMB The 40A current specification is based on the rated continuous current limit of the SubConn Low Profile Connector on the battery hull [7]. This provides sufficient headroom, as testing indicates a typical current draw of 11A per battery when moving at full-speed. CAN Bus is used for inter-board communication within the AUV, hence CAN bus integration is critical.\n4.3 Component Standardisation To reduce cost and simplify procurement, certain components of the PMB are shared with the other PCBs onboard the AUV. Specifically, the STM32F103C8T6 and the ISOW1044B isolated CAN Transceiver (Table 7). This standardisation reduces design effort and chance of error as the same validated schematic and layout can be reused across the PCBs. This also allows for easier spare preparation as the same component can act as spares for the different PCBs.\nFigure 10: Common Schematic for STM32F103C8T6 Component Reason for Selection STM32F103C8T6 A widely used microcontroller that is onboard the “Blue-Pill” development board, ensuring high availability and supply stability. ISOW1044B Combines the isolated regulator and CAN transceiver into one single component, saving space onboard the PCB. Table 8: Reasons for the Components Selected for Standardisation 5. System Architecture In this section, the summarised power, electrical and connector architectures provide a big picture of the system. This aims to provide a holistic understanding of how the system is structured before delving into the detailed design of the PMB. Subsequent sections will explain how the design choices support the overall project goals.\nFigure 11: Summarised Power Architecture of PMB Figure 12: Summarised Communications Architecture of PMB Figure 13: Summarised Connectors Architecture of PMB 6. Improving AUV Performance One way to improve the AUV’s performance is by extending its run time. This enables longer in-water testing by reducing interruptions due to battery swaps. This supports uninterrupted testing to better simulate longer competition runs. Two methods were implemented to achieve this: renewing the current batteries and introducing accurate state-of-charge (SoC) estimation.\n6.1 Battery Renewal The batteries have been in use for over 2 years, with an estimated 200 cycles completed.\nFigure 14: Information on The Cycle Life of The Current Battery As the current battery hull design is expected to remain in use for several more competition cycles, the batteries should be renewed to avoid more degradation.\nOperationally, each AUV requires six batteries, organised into three sets of two: one set in use, one set charging, and one set on standby. Therefore, selecting cost-effective batteries can result in significant savings for the team.\nSpecification GrePow LiPo (current) Raitan Li-Ion MaxAmp Li-Ion Configuration 4S1P 4S4P 4S3P Fit within the current battery dimensions? Yes Yes Yes Capacity 15000mAh 16000mAh 15000mAh Weight 1355g 1200g 898g Maximum Current Draw 60A 80A 75A Cost SGD 320 SGD 250 SGD 451 Table 9 : Table of Comparison for Batteries Lithium-ion batteries were chosen for comparison due to its longer lifespan and higher energy density [3]. With its higher capacity and lower cost, the Raitan Li-Ion battery was selected. Additionally, the team’s prior experience with Raitan provided confidence in the reliability and performance of their product.\nTwo Raitan Li-Ion batteries were procured for testing and compared with the current batteries.\nSpecification GrePow LiPo (current) Raitan Li-Ion (New) Dimensions 190mm x 75mm x 42mm 171mm x 77mm x 44mm Mass 1241g 1179g Time taken to draw 7A from fully charged to nominal voltage 40 Minutes 60 Minutes Table 10: Comparing GrePow LiPo Batteries with Raitan Li-Ion Batteries Figure 15: Voltage Drop over Time at 7A Constant Current Draw Figure 16: Photo of Grepow Battery (left) and Raitan Li-Ion Battery (Right) Figure 17: Photo of New Batteries in AUV4.1 Battery Hull Raitan Li-Ion battery has been verified to be comparable to the GrePow LiPo battery making it a suitable replacement for the old batteries.\n6.2 Accurate SoC Estimation As mentioned in Section 2.3.2, the team previously relied on voltage to estimate the battery capacity. This approach tends to end tests prematurely, as conservative voltage thresholds fail to account for load and battery age. By utilising the gauging feature on battery management chip, we can determine a more accurate SoC, allowing in-water tests to run longer without risking battery damage.\n6.2.1 Literature Review Looking at RoboSub 2023 and RoboSub 2024 Teams’ Technical Design Report, only 2 other teams (Cornell University [8] and The Ohio State University [9]) developed a PMB with a battery gauge. The teams used the BQ40Z50 and BQ40Z80 chips from Texas Instruments (TI) respectively.\n6.2.2 Justification for Chip Selection Additionally TI, offers extensive community support on its forum and provides numerous resources guiding customers in using its chips (Figure 18, Figure 19, Figure 20).\nFigure 18: Search Results of TI Forums Figure 19: TI’s YouTube Playlist on Battery Management Figure 20: Documents for BQ40Z50 Additionally, its software application “bqStudio” provides an easy interface with the chip (Figure 21).\nFigure 21: Screenshot of bQStudio To leverage the extensive resources available and increase likelihood of success, a compatible chip from the TI family was shortlisted. Successful implementations by teams such as Cornell and OSU further validate the chip’s reliability in AUV applications.\nFeature BQ34110 (Current) BQ40Z50 (Proposed) Battery Gauging Algorithm Compensated End-of-Discharge Voltage TI’s Impedance Track Algorithm Comparison [10] - Inaccurate SoC after idle period\n- Affected by aged battery\n- Remains accurate after idle\n- Resistant to ageing and temperature changes\n- Remains accurate at high level of discharge.\n- Lower error rate. BQ40Z50 was chosen as it supports up to 4-Series Li-Ion or LiPo Battery Packs. It also offers programmable protection features (Section 8.2) as well as Impedance Tracking and Cell Balancing. The chip is also able to track the number of cycles the batteries have been through. This reduces the need to guess when the batter capacity falls below a certain amount and hence prepare the operator to procure a new set of batteries. Furthermore, its large number of available stocks (Figure 22) ensures that the PMB can be easily reproduced or repaired in the future if necessary.\nFigure 22: BQ40Z50 Availability on Mouser 6.2.3 Evaluation of SoC Accuracy Hence, to evaluate the SoC accuracy, the new Li-Ion battery along with the PMB went through a learning cycle [11].\nWhen discharged at a constant current of 7A, the Voltage and SoC reported by BQ40Z50 was recorded (Table 11). When using the LiPo battery, the team had a threshold of 15.2V (nominal voltage + 0.4V). Based on the chart, this would be roughly at 40% Depth of Discharge (DoD) (Figure 23).\nFigure 23: Chart of Voltage and its Corresponding Capacity [2] If we were to do the same for the Li-Ion battery the threshold would be 14.8V. This would mean that the run would end before 65 minutes. However, by using SoC the vehicle would be able to run to at least 75 minutes, extending the run time by 15.4 %.\nTime (minutes) Voltage (V) Relative State of Charge Reported by BQ40Z50 0 16.5 100% 10 16.03 93% 20 15.91 86% 30 15.45 74% 45 15.18 67% 55 15.94 59% 65 14.68 51% 75 14.4 45% Table 11: BQ40Z50 SoC Reporting During Constant Current Discharge The BQ40Z50 is also able to report the time taken to fully charge the batteries, and time taken to fully discharge the batteries. This time is calculated by the average power draw of the batteries.\nCase Start Time Starting Battery Voltage and SoC Predicted End Time Actual End Time Time Difference A 8:20 PM 16.42V, 84% 9:30 PM 9:10 PM 20 mins early B 1:07 AM 15.76V, 65% 3:15 AM 2:41 AM 34 mins early Table 12: Battery Charging Time Compared to BQ40Z50 Predicted End Time This can be useful as it allows members to better plan and anticipate battery changes at pool tests. While the predicted end time tends to be conservative, this behaviour is preferable as it provides a useful buffer when planning battery swaps.\n7. Enhance User Operability and Workflow One part of the project is to enhance user operability and workflow. User operability can be improved by allowing for easier operation and maintenance of the battery hull, reducing AUV’s downtime. Easier maintenance can also help prevent damage to the battery hulls. Improved workflow can help to identify potential issues and allow for early detection of faults. Both user operability and workflow can come together to increase the reliability of the vehicle.\n7.1 In-Hull Firmware Flashing Currently, the microcontroller on the PMB can only be programmed via the exposed Serial Wire Debug (SWD) pins on the PCB inside the battery hull. This process is time-consuming and increases the risk of sealing errors during reassembly. By enabling in-hull firmware flashing, software updates can be performed without physical disassembly, significantly reducing maintenance time and increasing operational efficiency.\n7.1.1 Prior Implementation: RobotX 2024 In-hull flashing was successfully implemented during RobotX 2024. A USB port was exposed on the side of the hulls onboard the Autonomous Surface Vessel (ASV), allowing members to update the firmware without opening the hull. This cuts down the time required for firmware update from five minutes to one minute.\nFigure 23: USB Port for Flashing on ASV4.0 7.1.2 Design Concept 1 - Firmware Flashing via CAN Bus Initially, an option was to use the CAN lines to flash firmware onto the microcontroller.\nFigure 24: AUV4.1 Battery Hull Power Connector Pinout However, this option increases complexity of the system as a bootloader has to be written to support the firmware upload over CAN Bus.\n7.1.3 Design Concept 2 - Repurposing the Balance Connector An alternate approach is to repurpose the AUV4.1 balance connector, which was originally used to expose the LiPo battery’s balance pins for external cell balancing during charging. However, as the BQ40Z50 chip support cell balancing, this connector is now redundant and can be reassigned for other functions.\nFigure 25: Old Balance Connector Pin Out The Balance Connector can be re-wired within the battery hull to expose the microcontroller programming pins (SWDIO, SWDCLK, RESET and Ground). Since communication with the BQ40Z50 chip is via SMBus, the SMBus lines (SMBD, SMBC and SMB GND) can also be exposed on the same connector. This allows the user to programme the microcontroller and the BQ40Z50 chip without unsealing the hull, reducing down time. Furthermore, it does not require significant development effort to implement this feature.\nFigure 26: New Balance Connector Pin Out 7.2 Remote Status Monitoring As discussed in in Section 2.3.3,the team currently relies on manual logging to monitor the battery hull’s internal pressure and temperature. This lack of historical data makes it difficult to determine if there is a slow leak. Furthermore recording key telemetry information such as individual cell voltages, state of health can also be logged to track the degradation of the batteries.\nAs such, the requirements for the remote status monitoring and its reasoning can be summarised below.\nRequirements Reasoning Automated Reporting To avoid human error. Wireless Update Data To avoid unsealing the hull to retrieve the data. Low Barrier of Entry Database As members from different sub-teams have to maintain the Battery Hull, the storage database should be easily accessed and used. Table 13: Requirements for Remote Status Monitoring and Their Justifications 7.2.1 Design Concept 1 - Microcontroller with Wireless Capabilities The initial design involved using a microcontroller with built-in WiFi capabilities (STM32Wx, Espressif MCUs), allowing it to connect to the internet whenever the battery hull is powered on. However, this approach is not ideal as the PMB is placed within a 3D printed metal hull, which would act as a Faraday cage. This would weaken the WiFi signal leading to unreliable connections.\nGiven that the battery is already connected to the internet when it is attached to the AUV (Figure 27), wireless capabilities are only necessary when the battery hull is charging in the BCB.\nFigure 27: Diagram of Data Flow from PMB to the Internet 7.2.2 Design Concept 2 - Accompanying PCB Within the Battery Charging Box To address these limitations, a revised design places a PCB with wireless capabilities in the BCB. The battery hull connects to the LiPo charger in the BCB via the connector in Figure 24. As such, the CAN Low and CAN High data line are unused during charging. Using this connection, a microcontroller can retrieve data from the PMB when it is charging and upload it online.\nHence the a Battery Telemetry Board (BTB) was designed to reside within the BCB. It uses an Espressif32-DevKitC V4 as it was readily available in the lab. While this would mean an additional component is required to reside within the BCB, it is worthwhile as other features such as Real-Time Safety and Status Notifications can be implemented on the same Battery Telemetry Board.\nThey key components of the BTB and its purpose are summarised in the table below:\nKey Components Functions Espressif ESP32-DevKitC V4 Microcontroller with WiFi capabilities to upload telemetry online. SSD1306 Onboard screen to display key information. ISOW1044B Isolated CAN transceiver to allow for CAN communication with the PMB. Buzzer Used to alert user of any potential fault. USB-C Connector \u0026 Voltage Regulator To power the board directly from the LiPo charger to simplify integration. Table 14: Components and Functions of the Battery Telemetry Board (BTB) Figure 28: Labelled Components on BTB BTB Schematics are in Appendix A.\n7.2.3 Data Flow The PMB constantly reports telemetry via five CAN Messages. The data sent over the messages includes critical information for fault detection (e.g.: voltage, current, internal pressure and temperature), information that can be useful to track degradation (E.g.: individual cell voltages, state of health) are also sent to be documented. Finally, telemetry data that can help in operational planning such as time to full charge and time to empty is transmitted to support efficient pool test scheduling.\nFigure 29: Data Flow from BTB to Telegram Channel and Google Sheets The BTB interprets the CAN messages and packages it to be sent to the Telegram Channel and a Google App Script. The Google App Script will then update the respective Google Sheets based on the PMB ID. The time recorded is obtained via NTP.\nGoogle Sheets was chosen as it has a low barrier of entry, allowing all members to easily access their data. Furthermore, it does not require any additional applications to view the data.\nFigure 30: Data Flow from BTB to Telegram Channel and Google Sheets Figure 31: Data Flow from BTB to Telegram Channel and Google Sheets To ensure data being published is accurate, there is a time out for all the telemetry received. If the BTP does not receive the same message ID from the same PMB within two times of its reporting frequency, all the data from that PMB is cleared. This ensures that only accurate data is recorded to not pollute the dataset for analysis.\nTelemetry\rReported on PMB Screen\rReported on Telegram Channel\rRecorded on Google Sheet\rVoltageYYY\rCell1 VoltageNNY\rCell2 VoltageNNY\rCell3 VoltageNNY\rCell4 VoltageNNY\rCurrentYYY\rSoCYYY\rTime to FullNYY\rAverage PowerNYY\rState of Health FCCNNY\rInternal PressureYYY\rTemp Probe 1NYY\rTemp Probe 2NYY\rInternal TemperatureYYY\rTable 15: Summary of Telemetry Availability Across Interfaces Due to limited space on the screen, only high-priority telemetry is shown to avoid clutter. The Telegram channel provides immediate operational updates, while full datasets are continuously uploaded to Google Sheets for future analysis. This tiered reporting strategy balances usability with traceability, ensuring the data remains actionable without overwhelming users.\n8. Improving Safety and Reliability Ensuring safety and reliability of the system requires timely identification and mitigation of faults must be before it damages the system. his section outlines three key strategies: leak detection in the battery hull, robust electrical protection features, and utilising good electrical practises to design a high power PCB.\n8.1 Real-Time Safety and Status Notifications As mentioned in Section 2.3.3, slow battery hull leaks are difficult to detect without consistent data. A possible solution will be the automatic notification of team members when a leak is detected by the system.\n8.1.1 Past Experiences During the testing and development of the Autonomous Surface Vessel, a Telegram Channel was running on the ASV to periodically report the battery voltage and current draw. This proved invaluable as it help the team to anticipate and prepare for battery swaps. Furthermore, it helped the team to identify a load-balancing issue in the vehicle that would have otherwise gone unnoticed.\nFigure 32: Telegram Channel Reporting ASV’s Battery Status 8.1.2 Chosen Method Telegram was selected as the alert platform due to its prior success and team-wide adoption. Furthermore, as it is used for internal communications, it provides a low-barrier of entry and high-visibility for any fault notification.\n8.1.3 Leak Detection Implementation A Google App Script processes data uploaded from the Battery Telemetry Board (BTB) and checks for the following leak indicators:\nCondition Notification Internal Pressure Below 107 ALERT: PMB IS LEAKING! Drop in the Ratio of Internal Pressure to Temperature \u003e 0.5 ALERT: PMB MIGHT BE leaking, please observe. Table 16: Leak Detection Thresholds and Corresponding Notifications The leak detection is based on the Gay Lussac’s Law [4] which states that the pressure of a gas is directly proportional to its temperature at constant volume. Hence, if the Battery Hull is not leaking, the amount of gas in the hull should remain the same. Thus, the ratio of internal pressure to temperature should remain consistent despite temperature changes. Therefore, a significant deviation in this ratio would suggest a potential leak.\nTo obtain the previous Internal Pressure to Temperature ratio, the Google App Script obtains the last recorded data for the PMB on the Google Sheet.\nThe threshold of 0.5 is determined by observing the change in temperature and internal pressure of three battery hulls.\nPressure Temp P/T P/T Difference 110.30 24 4.596 - 110.38 25 4.415 -0.181 110.45 27 4.091 -0.324 110.52 27 4.093 0.003 110.58 27 4.096 0.002 110.71 28 3.954 -0.142 110.80 28 3.957 0.003 110.85 28 3.959 0.002 Table 17: Changes in Pressure and Temperature of Battery Hull A Pressure Temp P/T P/T Difference 112.49 24 4.687 - 112.54 24 4.689 0.002 112.59 25 4.504 -0.186 112.63 25 4.506 0.002 112.67 25 4.507 0.002 112.75 25 4.510 0.003 112.80 25 4.512 0.002 112.85 26 4.340 -0.172 Table 18: Changes in Pressure and Temperature of Battery Hull B Pressure Temp P/T P/T Difference 111.88 24 4.662 - 112.04 26 4.309 -0.352 112.10 28 4.004 -0.306 112.16 28 4.006 0.002 112.23 29 3.870 -0.136 112.34 29 3.874 0.004 112.43 29 3.877 0.003 112.47 30 3.749 -0.128 Table 19: Changes in Pressure and Temperature of Battery Hull B By feeding various data to the BTB, we are able to simulate a leaking hull, leading to an alert sent to the Telegram Channel.\nFigure 33: Telegram Channel Reporting a Possible Leak in PMB2 Figure 34: Telegram Channel Reporting a Leak in PMB1 The same Telegram channel is also used to broadcast the progress of the battery charging and notifies members when it is fully charged. This feature addresses a common operational issue, where team members may forget to turn off the charger, especially after fatigue from a long day of pool tests. By receiving timely reminders, the team can ensure a safer operation by turning off the charger when the battery is fully charged.\nFigure 35: Telegram Channel Reporting a Fully Charged PMB1 8.2 Protection Features BQ40Z50 comprises of various protection features. This includes two tiers of protection. The first tier disconnect the circuits via MOSFETs, while the second tier permanently disable the battery pack by blowing the fuse. Within the first tier there are also hardware protections that can be configured for faster a response from the chip.\nThese features collectively protect the vehicle from electrical fault, improving the reliability of the system.\nFigure 36: Configuring BQ40Z50 Protection Parameters in bqStudio Several key safety features were configured and tested:\nFeature Test Result Overcurrent in Discharge (OCD) Used a load tester to verify that discharging above the set current value for the specified time would turn off the discharge MOSFET. Overload in Discharge Protection (AOLD) Almost instantaneous cut off when discharging above the set current limit. Over Charging Current Protection (OCC) When the charging current is higher than the preset threshold, the Charging MOSFET is turned off. Table 20: Using bQStudio to configure Protection Settings Additionally, there is a secondary overvoltage protection chip (BQ294701) monitors cell voltages independently and can also activate the fuse if an overvoltage is detected. This act as a fall back if the BQ40Z50 is malfunctioning.\n8.3 PMB PCB Design To ensure that the PMB is reliable, good PCB design practices must be followed to ensure both signal integrity and that the PMB can support the power required. The PMB design adheres to recommendations from TI’s SLUA660A Advanced Gas Gauge Circuit Design document [5], ensuring proper layout and component interfacing.\nThe PMB is a 4-Layer PCB with signal routing on the outer layers and dedicated internal planes for power and ground. (Appendix B)\nTo remain backwards compatible, the PMB has the same dimensions and connector layout as its predecessor.\n8.3.1 Design for High Power Handling The PMB is designed to handle 40A of continuous current. Hence, 2oz copper was used on the outer layers of the PCB, where the power path are, to reduce temperature rise. The traces are also made as wide as possible to reduce resistance.\nFigure 37: 3D Model of Power Path Figure 38: Power Path on the Top Layer The IPTC014N10NM5 MOSFET was chosen as it has a top side cooling package. This allows the use of thermal pad to conduct the heat from the MOSFET to the top of the battery hull [6].\nFigure 39: MOSFET Highlighted on The New PMB A test was conducted to compare the new MOSFET with the old MOSFET and it’s thermal conducting capabilities. The PMB is placed Within the enclosed battery hull with starting temperature of 28 Celsius. A continuous current draw of 40A was carried out for 10 minutes. A thermal camera was then use to measure the temperature of the PCB.\nFigure 40: Thermal Image of the New PMB after Load Test Figure 41: Thermal Image of the Old PMB after Load Test It can be observed that the old PMB has a higher temperature after the load test, indicating that the MOSFETs on the new PMB are better at conducting thermal heat away.\nTo ensure reliable power supply, a power consumption chart was drawn up to verify that the selected voltage regulator are able to supply enough power.\nFigure 42: PMB’s Power Consumption Chart 8.3.2 Design for Signal Integrity Ensuring that the signals transmitted on the data lines are not affected by noise are critical to creating a reliable PMB.\nFirstly, the board was split into high-power and low-power zones to minimise interference.\nFigure 43: Split between Higher and Lower Power Sections of the PMB (Red Line Divides the Sections) Due to the variation in current drawn from the battery, it is likely that there would be noise if the low power components were powered from the same source. Hence, an Isolated DC-DC regulator was used to isolate the Battery and AUV power from the microcontroller’s components. A low-droput regulator (LDO) was used to step down 3.3V for 3.3V components.\nThe BQ40Z50 communicates via SMBus, which crosses between the high and lower power sections. Therefore an I2C isolator is used. To protect the SMBus lines from electrostatic discharge and voltage spikes, TVS and Zener diodes are connected to the lines\nThe various Power and Nets are summarised in the table below:\nPower and Ground Nets Description +3V3, +5, GND Isolated power and ground to power the components associated with the microcontroller. Batt_Pos, Batt_Neg Positive and negative input from the battery. AUV_Pos, +3V3_UnIso, AUV_Neg Positive and negative output to the AUV, and a 3V3 that references the AUV_Neg. Table 21: Table of Power and Ground Nets with Its Description This can be further seen in the division of the Power and Ground Plane within the PMB.\nFigure 44: PMB Power Plane Figure 45: PMB Ground Plane 8.3.4 User Interface The PMB uses reed-switches and latching relay to allow the battery to be turned on or off without unsealing the hull. To turn off the system, the MCU Checks for a HIGH signal from the “OFF” reed switch, ensuring that the relay is only reset after tasks are safely concluded. This would be critical to prevent file corruption if onboard logging is implemented.\nFigure 46: Relay Circuit on The PMB Key telemetry information being displayed on the screen can also alert users immediately to any potential issues within the battery hull.\nFigure 47: Telemetry Display and Reed Switches for The Battery Hull The final layout and assembled PCB are shown below.\nFigure 48: Top View of PMB Figure 49: Bottom View of PMB 9. System Evaluation The new design is able to meet the functional requirements stated in Section 4.\nRequirements Achieved Description Backward Compatible Yes The battery and PMB fit within the previous battery hull and use the existing connectors. Voltage Output Yes A 4S Li-Ion battery was used. Continuous Current Yes Tested that the board is able to draw 40A for 10 minutes. Telemetry Yes Voltage, current, and internal pressure are displayed on the telemetry screen. Voltage was verified with a multimeter; current was calibrated using a load tester. Charging Yes Able to charge the battery. Table 22: Comparison between Functional Requirements and Its Status The sub goals set out in Section 3 has been met.\nSub Goals Implementation Improvements Enhance User Operability and Work Flow - In-hull firmware update via balance connector\n- Remote status monitoring via Battery Telemetry Board - Firmware update time reduced from 25 minutes to 3 minutes.\n- Members can track charging status and refer to historical battery data. Improve Safety and Reliability - Real-time safety and status notification via Telegram\n- Protection features with BQ40Z50 - Immediate alerts when faults are detected.\n- AUV electrical system is protected from potential electrical faults. Improve AUV Performance - New Li-Ion batteries\n- Accurate SoC estimation with BQ40Z50 - In-water testing time can be extended. Table 23: Summary of Sub Goals and Its Implementation and Improvements Unfortunately, there were also mistakes when designing the PCBs that have to be rectified when testing.\nPCB Mistake Problems Current Fix PMB No pull-up resistor on the I2C lines between the MCU, screen, and pressure sensor Unable to establish communications on I2C lines Pull-up resistor soldered onto the board PMB No pull-down resistor for the signal from the MCU to reset the reed switch Relay would be reset when the MCU is powered on, leading to the power being cut Pull-down resistor soldered onto the board BTB Resistors from the CC lines on the USB-C connector are pulled up instead of down USB-C would not negotiate properly for power delivery Existing resistor removed and new resistor soldered to pull CC lines to ground Table 24: Summary of PCB Mistakes and Its Fixes Figure 50: Soldering Pull Down Resistor on PMB Figure 51: Soldering Pull Down Resistor on BTB The integration of SoC tracking, protection features and remote status monitoring redefines the PMB from being a passive Power Monitoring Board to a Power Management Board. Furthermore, the addition of a BTB to the BCB provides an integrated system to monitor and alert operators of potential faults within the AUV’s battery system.\nDesigned with backward and forward compatibility in mind, the new system is built to support current and future AUV platforms. This implementation enhance safety, usability and reliability, putting the team in a This changes being done while keeping in mind of backwards and forwards compatibility, positions the team for continued success at RoboSub.\n11. Impact and Future Work Due to limited availability of serviceable battery hulls and competing priorities during pool test, the new battery system has not been tested in-water with the AUV. Hence, testing with the AUV should be done to fully validate the entire system under actual operating conditions.\nThe BQ40Z50 supports communication of target charging voltage and current via SMBus. This opens the opportunity to develop a custom charger that interfaces directly with the battery pack, enabling smart charge regulation. The BTP can be integrated with the custom charger to report the charging status.\nOne usability issue identified relates to connector reuse. In an effort to minimise modifications to the existing battery hull, identical connectors were used for both battery balance lines and microcontroller programming pins. This design choice introduces the risk of incorrect connections during assembly, which could damage the microcontroller. While backward compatibility was prioritised, minor modifications should still be made when necessary to prevent user error and enhance system robustness.\nIf no major issues are discovered during pool testing, the PMB will be deployed at RoboSub 2025 and RoboSub 2026 across the AUVs fielded by BBAS. Furthermore, with BBAS releasing our PCB schematics online, the PMB can serve as a reference to other AUV teams working on battery management systems. Notably, no internet-connected charging system were observed at RoboSub 2023. By demonstrating this feature at RoboSub 2025, BBAS can inspire other teams to implement remote monitoring for their systems.\nReferences Texas Instruments, “bq34110 Multi-Chemistry CEDV Battery Gas Gauge for Rarely Discharged Applications,” bq34110 datasheet, Aug. 2015 [Revised Nov. 2016] “Complete Guide to Lipo Battery Voltage,” Ufine Battery [Official], https://www.ufinebattery.com/blog/useful-overview-of-lipo-battery-voltage/ (accessed Apr. 2, 2025). “LiPo vs Lithium Ion Batteries for Unmanned \u0026 Robotics Applications | Unmanned Systems Technology,” Unmanned Systems Technology, Jan. 26, 2023. https://www.unmannedsystemstechnology.com/feature/lipo-vs-lithium-ion-batteries-for-unmanned-robotics-applications/ “Gas Laws,” Gas laws, https://www.chem.fsu.edu/chemlab/chm1045/gas_laws.html (accessed Apr. 2, 2025). Texas Instruments, “bq40z50 Advanced Gas Gauge Circuit Design,” Application Report, Nov. 2012 [Revised Sep. 2014] Infineon, “Recommendations for Board Assembly of Infineon Packages with Dual Row Gullwing Leads,” Nov 2020 “Subconn low profile - 9 contacts,” Underwater Technology, https://www.macartney.com/connectivity/subconn/subconn-low-profile-series/subconn-low-profile-9-contacts/ (accessed Apr. 2, 2025). A. Fink et al., “Design, Implementation, and Strategy of the Polaris and Sirius AUVs,” Cornell Univ. Autonomous Underwater Vehicles, Tech. Rep., Jul. 2024. [Online]. Available: https://robonation.org/app/uploads/sites/4/2024/07/RS24_TDR_Cornell-compressed.pdf [1] N. Becker, A. Dellacqua, B. Knutson, M. Oinonen, R. Pafford, and C. Tucker, “Design Review of Talos: An Autonomous Underwater Vehicle by The Ohio State University’s Underwater Robotics Team,” The Ohio State Univ., Tech. Rep., Jun. 2023. [Online]. Available: https://robonation.org/app/uploads/sites/4/2023/06/TDR_THEOhioStateUniversity_RS2023-compressed.pdf Texas Instruments, “Battery Gauging Algorithm Comparison,” Application Report, Dec. 2023 Texas Instruments, “Achieving The Successful Learning Cycle,” Application Report, Jul. 2018 Appendix A: PCB Schematics Power Monitoring Board Schematic Battery Telemetry Board Schematic Appendix B: Individual Layers of Power Monitoring Board Top Layer of PMB Power Plane of PMB Ground Plane of PMB Bottom Layer of PMB Appendix C: Relay Circuit Calculation Relay Circuit Calculation Appendix D: Battery Specification AUV4.1 LiPo Battery AUV4.5 Li-Ion Battery Appendix E: 3D Model of AUV4.5 Power Monitoring Board AUV4.5 Power Management Board 3D Model\r",
  "wordCount" : "6580",
  "inLanguage": "en",
  "datePublished": "2025-04-03T00:00:00Z",
  "dateModified": "2025-04-04T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "Teoh Xu En"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/website/report/final_report/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "AUV Battery Management System",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/website/favicon.ico"
    }
  }
}
</script>



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" integrity="sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" integrity="sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" integrity="sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk" crossorigin="anonymous"
  onload="renderMathInElement(document.body);"></script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: "\\begin{equation}", right: "\\end{equation}", display: true},
            {left: "\\begin{equation*}", right: "\\end{equation*}", display: true},
            {left: "\\begin{align}", right: "\\end{align}", display: true},
            {left: "\\begin{align*}", right: "\\end{align*}", display: true},
            {left: "\\begin{alignat}", right: "\\end{alignat}", display: true},
            {left: "\\begin{gather}", right: "\\end{gather}", display: true},
            {left: "\\begin{CD}", right: "\\end{CD}", display: true},
          ],
          throwOnError : false
        });
    });
</script>
 


</head>

<body class="" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/website/" accesskey="h" title="Battery Management System">
                <img src="http://localhost:1313/website/favicon.ico" alt="" aria-label="logo"
                    height="18"
                    width="18">Battery Management System</a>
            <div class="logo-switches">
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/website/report/" title="Report">
                    <span>Report</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/website/guides/" title="Guides">
                    <span>Guides</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/website/configurations/" title="Configurations">
                    <span>Configurations</span>
                </a>
            </li>
        </ul>
    </nav>
</header>

    <main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Development of A Battery Management System for AUV4.5
    </h1>
    <div class="post-meta"><span title='2025-04-03 00:00:00 +0000 UTC'>April 2025</span>&nbsp;&middot;&nbsp;Teoh Xu En&nbsp;&middot;&nbsp;<a href="https://bumblebee.sg/" rel="noopener noreferrer" target="_blank">Team Website</a>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#acknowledgements">Acknowledgements</a></li>
    <li><a href="#list-of-common-acronyms">List of Common Acronyms</a></li>
    <li><a href="#1-summary">1. Summary</a></li>
    <li><a href="#2-problem-background">2. Problem Background</a>
      <ul>
        <li><a href="#21-introduction">2.1 Introduction</a></li>
        <li><a href="#22-current-system">2.2 Current System</a></li>
        <li><a href="#23-limitations-of-current-system">2.3 Limitations of Current System</a></li>
        <li><a href="#24-problem-analysis">2.4 Problem Analysis</a></li>
      </ul>
    </li>
    <li><a href="#3-project-goal">3. Project Goal</a>
      <ul>
        <li><a href="#311-project-sub-goals">3.1.1 Project Sub Goals</a></li>
      </ul>
    </li>
    <li><a href="#4-design-considerations">4. Design Considerations</a>
      <ul>
        <li><a href="#41-backward-compatibility">4.1 Backward Compatibility</a></li>
        <li><a href="#42-functional-requirements">4.2 Functional Requirements</a></li>
        <li><a href="#43-component-standardisation">4.3 Component Standardisation</a></li>
      </ul>
    </li>
    <li><a href="#5-system-architecture">5. System Architecture</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#6-improving-auv-performance">6. Improving AUV Performance</a>
      <ul>
        <li><a href="#61-battery-renewal">6.1 Battery Renewal</a></li>
        <li><a href="#62-accurate-soc-estimation">6.2 Accurate SoC Estimation</a></li>
      </ul>
    </li>
    <li><a href="#7-enhance-user-operability-and-workflow">7. Enhance User Operability and Workflow</a>
      <ul>
        <li><a href="#71-in-hull-firmware-flashing">7.1 In-Hull Firmware Flashing</a></li>
        <li><a href="#72-remote-status-monitoring">7.2 Remote Status Monitoring</a></li>
        <li><a href="#721-design-concept-1---microcontroller-with-wireless-capabilities">7.2.1 Design Concept 1 - Microcontroller with Wireless Capabilities</a></li>
        <li><a href="#722-design-concept-2---accompanying-pcb-within-the-battery-charging-box">7.2.2 Design Concept 2 - Accompanying PCB Within the Battery Charging Box</a></li>
        <li><a href="#723-data-flow">7.2.3 Data Flow</a></li>
      </ul>
    </li>
    <li><a href="#8-improving-safety-and-reliability">8. Improving Safety and Reliability</a>
      <ul>
        <li><a href="#81-real-time-safety-and-status-notifications">8.1 Real-Time Safety and Status Notifications</a></li>
        <li><a href="#82-protection-features">8.2 Protection Features</a></li>
        <li><a href="#83-pmb-pcb-design">8.3 PMB PCB Design</a></li>
      </ul>
    </li>
    <li><a href="#9-system-evaluation">9. System Evaluation</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#11-impact-and-future-work">11. Impact and Future Work</a></li>
    <li><a href="#references">References</a></li>
    <li><a href="#appendix-a-pcb-schematics">Appendix A: PCB Schematics</a></li>
    <li><a href="#appendix-b-individual-layers-of-power-monitoring-board">Appendix B: Individual Layers of Power Monitoring Board</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#appendix-c-relay-circuit-calculation">Appendix C: Relay Circuit Calculation</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#appendix-d-battery-specification">Appendix D: Battery Specification</a></li>
    <li><a href="#appendix-e-3d-model-of-auv45-power-monitoring-board">Appendix E: 3D Model of AUV4.5 Power Monitoring Board</a></li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="acknowledgements">Acknowledgements<a hidden class="anchor" aria-hidden="true" href="#acknowledgements">#</a></h2>
<p>Firstly, I would like to thank Team Bumblebee for the opportunity to work on this project.This project would not have been possible without the support of the many dedicated Bumblebee Members. I am especially grateful to Chai Zi Yang and Tan Chern Lin Justin for taking the time to review my PCB designs, Chen Jia Wei for spending countless hours troubleshooting with me and Marvin Pranajaya for his valuable advice on the Power Management Board. I would also like to thank Guk Yi Siong for assisting with the collection of power consumption data during in-water testing and Ananya Agarwal for her work on the Battery Hulls.</p>
<p>Additionally, I would like to express my gratitude to Parker Schless from Cornell AUV, for generously taking the time to address my technical queries on the implementation of the BQ40Z50 chip.</p>
<p>I also wish to acknowledge the support provided by the NUS College of Engineering, particularly Ms Annie, Mr Patrick, and Mr Graham from the Engineering Design and Innovation Centre. I would also like to thank Prof Goh Cher Hiang and Mr Eugene Ee for taking the time to review my project and provide valuable advice.</p>
<p>Finally, I am deeply grateful to my family for their unwavering patience and support through my journey in Team Bumblebee.</p>
<hr>
<h2 id="list-of-common-acronyms">List of Common Acronyms<a hidden class="anchor" aria-hidden="true" href="#list-of-common-acronyms">#</a></h2>
<div align="center">
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>Acronym</strong></th>
          <th style="text-align: center"><strong>Definition</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"><strong>ASV</strong></td>
          <td style="text-align: center">Autonomous Surface Vessel</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>AUV</strong></td>
          <td style="text-align: center">Autonomous Underwater Vehicle</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>BBAS</strong></td>
          <td style="text-align: center">Bumblebee Autonomous Systems</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>BCB</strong></td>
          <td style="text-align: center">Battery Charging Box</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>BTB</strong></td>
          <td style="text-align: center">Battery Telemetry Board</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>CAN</strong></td>
          <td style="text-align: center">Controller Area Network</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>OCS</strong></td>
          <td style="text-align: center">Operator Control Station</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>PCB</strong></td>
          <td style="text-align: center">Printed Circuit Board</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>PMB</strong></td>
          <td style="text-align: center">Power Monitoring Board</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>SoC</strong></td>
          <td style="text-align: center">State of Charge</td>
      </tr>
  </tbody>
</table>
</div>
<hr>
<h2 id="1-summary">1. Summary<a hidden class="anchor" aria-hidden="true" href="#1-summary">#</a></h2>
<p>This project focuses on developing a Power Monitoring Board for the upcoming Autonomous Underwater Vehicle, AUV4.5. The PMB is a critical component of the vehicle’s electrical system, designed to interface the battery reliably and safely with the AUV.</p>
<p>The new PMB introduces key features such as accurate state-of-charge tracking and in-hull firmware upgrades while maintaining backward compatibility with AUV4.1. Additionally, a new Battery Telemetry Board (BTB) will be integrated into the Battery Charging Box (BCB) enabling real-time monitoring, wireless data upload and automated fault detection during battery charging.</p>
<hr>
<h2 id="2-problem-background">2. Problem Background<a hidden class="anchor" aria-hidden="true" href="#2-problem-background">#</a></h2>
<h3 id="21-introduction">2.1 Introduction<a hidden class="anchor" aria-hidden="true" href="#21-introduction">#</a></h3>
<p>Bumblebee Autonomous Systems (BBAS) is a student-led project team that designs and builds Autonomous Underwater Vehicles (AUVs) for the annual RoboSub competition. Following lessons learned from AUV4.1’s participation in RoboSub 2023 (Figure 1), the team is concurrently developing AUV4.5 for RoboSub 2025 and AUV5.0 for RoboSub 2026 (Table 1).</p>
<p><img loading="lazy" src="RoboSub2023.jpeg" alt="AUV4.1 at RoboSub 2023"  />
</p>
<h5 id="figure-1-auv41-at-robosub-2023">Figure 1: AUV4.1 at RoboSub 2023<a hidden class="anchor" aria-hidden="true" href="#figure-1-auv41-at-robosub-2023">#</a></h5>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>Competition</strong></th>
          <th style="text-align: center"><strong>Vehicles Deployed</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">RoboSub 2023</td>
          <td style="text-align: center">AUV4.1</td>
      </tr>
      <tr>
          <td style="text-align: center">RoboSub 2025</td>
          <td style="text-align: center">AUV4.5</td>
      </tr>
      <tr>
          <td style="text-align: center">RoboSub 2026</td>
          <td style="text-align: center">AUV4.5 and AUV5.0</td>
      </tr>
  </tbody>
</table>
<h5 id="table-1-auv-deployments-in-robosub-competitions">Table 1: AUV Deployments in RoboSub Competitions<a hidden class="anchor" aria-hidden="true" href="#table-1-auv-deployments-in-robosub-competitions">#</a></h5>
<p>AUV4.5 retains the same hull design as AUV4.1 but features a newly developed electrical and software subsystem. This new electrical subsystem is designed to be mechanically compatible with the existing AUV4.1 hull while also serving as the baseline for AUV5.0.</p>
<h3 id="22-current-system">2.2 Current System<a hidden class="anchor" aria-hidden="true" href="#22-current-system">#</a></h3>
<p>The current power system for the AUVs comprises two main components, the Battery Hull (Figure 2) and the Battery Charging Box (BCB). Each Battery Hull houses a Power Monitoring Board (PMB) and a LiPo battery.</p>
<p>The PMB (Figure 3) monitors and reports key telemetry data, such as the battery&rsquo;s voltage, current, battery hull&rsquo;s temperature and pressure, both on the screen and via the CAN Bus. Two such hulls are connected to power to the AUV. The waterproof designs allows for quick battery swap during pool test by eliminating the need to unseal the main vehicle hull.</p>
<p><img loading="lazy" src="BatteryHull.png" alt="Battery Hull"  />
</p>
<h5 id="figure-2-metal-3d-printed-battery-hull">Figure 2: Metal 3D-Printed Battery Hull<a hidden class="anchor" aria-hidden="true" href="#figure-2-metal-3d-printed-battery-hull">#</a></h5>
<p><img loading="lazy" src="AUV4.1PMB.png" alt="AUV4.1 PMB"  />
</p>
<h5 id="figure-3-auv41s-power-monitoring-board">Figure 3: AUV4.1&rsquo;s Power Monitoring Board<a hidden class="anchor" aria-hidden="true" href="#figure-3-auv41s-power-monitoring-board">#</a></h5>
<p><img loading="lazy" src="assembled.png" alt="Assembled Battery Hull"  />
</p>
<h5 id="figure-4-assembled-battery-hull">Figure 4: Assembled Battery Hull<a hidden class="anchor" aria-hidden="true" href="#figure-4-assembled-battery-hull">#</a></h5>
<p>The BCB (Figure 5) comprises an AC-DC power supply and a LiPo charger. It includes connectors that interface directly with the battery hull, allowing the battery to be charged without removing it from the hull.</p>
<p><img loading="lazy" src="bcb.png" alt="Battery Charging Box"  />
</p>
<h5 id="figure-5-battery-charging-box">Figure 5: Battery Charging Box<a hidden class="anchor" aria-hidden="true" href="#figure-5-battery-charging-box">#</a></h5>
<h3 id="23-limitations-of-current-system">2.3 Limitations of Current System<a hidden class="anchor" aria-hidden="true" href="#23-limitations-of-current-system">#</a></h3>
<p>Deploying the current system at RoboSub 2023 identified several challenges.</p>
<h4 id="231-challenges-with-battery-hull-sealing">2.3.1 Challenges with Battery Hull Sealing<a hidden class="anchor" aria-hidden="true" href="#231-challenges-with-battery-hull-sealing">#</a></h4>
<p>The limited space within the battery hull and the need for a watertight seal, makes sealing and unsealing the hull a challenging and time-consuming process. Without error, unsealing takes 2 members approximately 10 minutes, while resealing requires another 15 minutes. However, the confined space often results in disconnected cables during assembly, further complicating the process. This overhead increase downtime and the risk of assembly errors.</p>
<p><img loading="lazy" src="sealing.png" alt="Sealing a Battery Hull at RoboSub 2023"  />
</p>
<h5 id="figure-6-two-man-team-attempting-to-seal-a-battery-hull-at-robosub-2023">Figure 6: Two Man Team Attempting to Seal a Battery Hull at RoboSub 2023<a hidden class="anchor" aria-hidden="true" href="#figure-6-two-man-team-attempting-to-seal-a-battery-hull-at-robosub-2023">#</a></h5>
<h4 id="232-limited-capabilities-of-battery-fuel-gauge">2.3.2 Limited Capabilities of Battery Fuel Gauge<a hidden class="anchor" aria-hidden="true" href="#232-limited-capabilities-of-battery-fuel-gauge">#</a></h4>
<p>The PMB currently uses BQ34110 chip as a gas gauge, which is designed for rarely discharged applications and lacks essential protection features [1], reducing the AUV&rsquo;s reliability. Furthermore, the battery gauging capability was also not used, leading the team to rely on voltage readings to estimate the capacity of the battery. This method is inaccurate as the battery voltage remains relatively constant over a significant portion of the discharge cycle, while the actual capacity decreases rapidly (Figure 7). To err on the side of caution, the pool test is ended when the voltage drops to the nominal level, further limiting the AUV&rsquo;s runtime.</p>
<p><img loading="lazy" src="voltagecapacity.webp" alt="Discharge Voltage Curve"  />
</p>
<h5 id="figure-7-typical-li-ion-discharge-voltage-curve-2">Figure 7: Typical Li-Ion Discharge Voltage Curve [2]<a hidden class="anchor" aria-hidden="true" href="#figure-7-typical-li-ion-discharge-voltage-curve-2">#</a></h5>
<h4 id="233-challenges-with-tracking-battery-hulls-pressure-and-temperature">2.3.3 Challenges with Tracking Battery Hull&rsquo;s Pressure and Temperature<a hidden class="anchor" aria-hidden="true" href="#233-challenges-with-tracking-battery-hulls-pressure-and-temperature">#</a></h4>
<p>During assembly, the battery hull is pressurised. Monitoring changes in pressure and temperature can alert the team to potential leaks. Currently, this tracking is done manually and only when a leak is
suspected. his reactive approach limits the availability of historical data. Manual tracking can lead to missing data or recording error, reducing the effectiveness of leak detection.</p>
<p><img loading="lazy" src="manualtrack.png" alt="Manually Logging Battery&rsquo;s Hull and Temperature on the Battery Hull&rsquo;s Lid"  />
</p>
<h5 id="figure-8-manually-logging-batterys-hull-and-temperature-on-the-battery-hulls-lid">Figure 8: Manually Logging Battery&rsquo;s Hull and Temperature on the Battery Hull&rsquo;s Lid<a hidden class="anchor" aria-hidden="true" href="#figure-8-manually-logging-batterys-hull-and-temperature-on-the-battery-hulls-lid">#</a></h5>
<p><img loading="lazy" src="excel.png" alt="Manually Logging Battery&rsquo;s Hull and Temperature on Excel"  />
</p>
<h5 id="figure-9-manually-logging-batterys-hull-and-temperature-on-excel">Figure 9: Manually Logging Battery&rsquo;s Hull and Temperature on Excel<a hidden class="anchor" aria-hidden="true" href="#figure-9-manually-logging-batterys-hull-and-temperature-on-excel">#</a></h5>
<h3 id="24-problem-analysis">2.4 Problem Analysis<a hidden class="anchor" aria-hidden="true" href="#24-problem-analysis">#</a></h3>
<p>The limitations in the current system can be split into three overarching themes: poor user operability, limited runtime and reduced reliability. These themes and their associated limitations are summarised in Table 1.</p>
<table>
  <thead>
    <tr>
      <th><b>Category</b></th>
      <th><b>Limitations</b></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="2"><strong>Poor User Operability</strong></td>
      <td>Challenges with Battery Hull Sealing</td>
    </tr>
    <tr>
      <td>Challenges with Tracking Battery Hull’s Pressure and Temperature</td>
    </tr>
    <tr>
      <td rowspan="2"><strong>Limited Run Time</strong></td>
      <td>Limitation of Battery Fuel Gauge</td>
    </tr>
    <tr>
      <td>Challenges with Battery Hull Sealing</td>
    </tr>
    <tr>
      <td rowspan="2"><strong>Poor Reliability</strong></td>
      <td>Limitation of Battery Fuel Gauge</td>
    </tr>
    <tr>
      <td>Challenges with Tracking Battery Hull’s Pressure and Temperature</td>
    </tr>
  </tbody>
</table>
<h5 id="table-2-categorisation-of-system-limitations">Table 2: Categorisation of System Limitations<a hidden class="anchor" aria-hidden="true" href="#table-2-categorisation-of-system-limitations">#</a></h5>
<p>Poor user operability increases the likelihood of mistakes at competition, especially under time constraints or operator fatigue. Furthermore, limited run time can lead to less testing opportunities and ultimately impacting competition performance (Table 2, Table 3). Finally, poor reliability increases the risk of mid-run failures or unplanned maintenance, leading to increased downtime.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center"></th>
          <th style="text-align: center"><strong>RobotX 2022</strong></th>
          <th style="text-align: center"><strong>RobotX 2024</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">Testing Time in Singapore</td>
          <td style="text-align: center">200 Hours</td>
          <td style="text-align: center">330 Hours</td>
      </tr>
      <tr>
          <td style="text-align: center">Final Score (adjusted)</td>
          <td style="text-align: center">1450</td>
          <td style="text-align: center">4450</td>
      </tr>
  </tbody>
</table>
<h5 id="table-3-table-of-competition-results-and-testing-time-in-singapore">Table 3: Table of Competition Results and Testing Time in Singapore<a hidden class="anchor" aria-hidden="true" href="#table-3-table-of-competition-results-and-testing-time-in-singapore">#</a></h5>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>Team</strong></th>
          <th style="text-align: center"><strong>Final Score</strong></th>
          <th style="text-align: center"><strong>Testing Time</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"><strong>NUS</strong></td>
          <td style="text-align: center">4450</td>
          <td style="text-align: center">49 Hours</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>KMOU</strong></td>
          <td style="text-align: center">2900</td>
          <td style="text-align: center">28 Hours</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>ERAU</strong></td>
          <td style="text-align: center">2250</td>
          <td style="text-align: center">33 Hours</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>Inspiration</strong></td>
          <td style="text-align: center">1600</td>
          <td style="text-align: center">25 Hours</td>
      </tr>
      <tr>
          <td style="text-align: center"><strong>NTU</strong></td>
          <td style="text-align: center">1050</td>
          <td style="text-align: center">17 Hours</td>
      </tr>
  </tbody>
</table>
<h5 id="table-4-comparison-of-final-score-and-testing-time-at-robotx-2024">Table 4: Comparison of Final Score and Testing Time at RobotX 2024<a hidden class="anchor" aria-hidden="true" href="#table-4-comparison-of-final-score-and-testing-time-at-robotx-2024">#</a></h5>
<hr>
<h2 id="3-project-goal">3. Project Goal<a hidden class="anchor" aria-hidden="true" href="#3-project-goal">#</a></h2>
<p>As a competition team, the primary objective is to maximise vehicle performance at RoboSub. By enhancing user operability and ensuring safe operation, the PMB directly contributes to system reliability, allowing for more in-water testing, and ultimately better competition performance.</p>
<p>The project goal can be summarised as:</p>
<div align="center">
    <b>
        To develop a battery management system that enhances user operability and workflow, ensures safe operation, and improves the AUV’s overall reliability and performance.
    </b>
</div>
<h3 id="311-project-sub-goals">3.1.1 Project Sub Goals<a hidden class="anchor" aria-hidden="true" href="#311-project-sub-goals">#</a></h3>
<p>Hence, a three-Pronged approach wass used to guide the development of the PMB, with each sub-goal detailed in its respective section.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Sub Goals</strong></th>
          <th style="text-align: center"><strong>Section Number</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Enhance User Operability and Work Flow</td>
          <td style="text-align: center"><a href="#7-enhance-user-operability-and-workflow">Section 7</a></td>
      </tr>
      <tr>
          <td style="text-align: left">Improve Safety and Reliability</td>
          <td style="text-align: center"><a href="#8-improving-safety-and-reliability">Section 8</a></td>
      </tr>
      <tr>
          <td style="text-align: left">Improve AUV Performance</td>
          <td style="text-align: center"><a href="#6-improving-auv-performance">Section 6</a></td>
      </tr>
  </tbody>
</table>
<h5 id="table-5-sub-goals-and-corresponding-report-section">Table 5: Sub Goals and Corresponding Report Section<a hidden class="anchor" aria-hidden="true" href="#table-5-sub-goals-and-corresponding-report-section">#</a></h5>
<hr>
<h2 id="4-design-considerations">4. Design Considerations<a hidden class="anchor" aria-hidden="true" href="#4-design-considerations">#</a></h2>
<h3 id="41-backward-compatibility">4.1 Backward Compatibility<a hidden class="anchor" aria-hidden="true" href="#41-backward-compatibility">#</a></h3>
<p>As outlined in <a href="#21-introduction">Section 2.1</a>, AUV4.5 has the same mechanical structure as AUV4.1. As such, the new PMB must remain mechanically and electrically compatible with the AUV4.1 battery hull. This backward compatibility ensures minimal modification to the existing support infrastructure when using the new PMB. Furthermore, designing to meet AUV4.1&rsquo;s specifications would also ensures forward compatibility with AUV5.0. This approach enables component reuse across AUV4.1, AUV4.5 and AUV5.0, reducing the need for custom variants and lowering the manufacturing cost by leveraging economies of scale.</p>
<p>To maintain backwards compatibility, the following constraints were identified.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Characteristics</strong></th>
          <th style="text-align: left"><strong>Constraints</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Dimensions</td>
          <td style="text-align: left">The PMB and battery must fit within a 192mm x 77.5mm x 44mm volume of the AUV4.1 battery hull.</td>
      </tr>
      <tr>
          <td style="text-align: left">Electrical Interface</td>
          <td style="text-align: left">Existing connectors for power delivery and charging must be retained.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-6-design-constraints-for-backward-compatibility">Table 6: Design Constraints for Backward Compatibility<a hidden class="anchor" aria-hidden="true" href="#table-6-design-constraints-for-backward-compatibility">#</a></h5>
<h3 id="42-functional-requirements">4.2 Functional Requirements<a hidden class="anchor" aria-hidden="true" href="#42-functional-requirements">#</a></h3>
<p>In addition to physical compatibility, the PMB must meet or exceed the technical performance of its predecessor. The following functional requirements were defined to ensure the board can support AUV4.1, AUV4.5 and AUV5.0.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Technical Capabilities</strong></th>
          <th style="text-align: left"><strong>Specifications</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Voltage Output</td>
          <td style="text-align: left">14.8V to 16.8V (4S)</td>
      </tr>
      <tr>
          <td style="text-align: left">Continuous Current</td>
          <td style="text-align: left">40A</td>
      </tr>
      <tr>
          <td style="text-align: left">Communication Protocol</td>
          <td style="text-align: left">CAN2.0</td>
      </tr>
      <tr>
          <td style="text-align: left">Telemetry</td>
          <td style="text-align: left">Voltage, Current, Internal Pressure, Internal Temperature displayed on the screen</td>
      </tr>
  </tbody>
</table>
<h5 id="table-7-core-functional-requirements-for-pmb">Table 7: Core Functional Requirements for PMB<a hidden class="anchor" aria-hidden="true" href="#table-7-core-functional-requirements-for-pmb">#</a></h5>
<p>The 40A current specification is based on the rated continuous current limit of the SubConn Low Profile Connector on the battery hull [7]. This provides sufficient headroom, as testing indicates a typical current draw of 11A per battery when moving at full-speed. CAN Bus is used for inter-board communication within the AUV, hence CAN bus integration is critical.</p>
<h3 id="43-component-standardisation">4.3 Component Standardisation<a hidden class="anchor" aria-hidden="true" href="#43-component-standardisation">#</a></h3>
<p>To reduce cost and simplify procurement, certain components of the PMB are shared with the other PCBs onboard the AUV. Specifically, the STM32F103C8T6 and the ISOW1044B isolated CAN Transceiver (Table 7). This standardisation reduces design effort and chance of error as the same validated schematic and layout can be reused across the PCBs. This also allows for easier spare preparation as the same component can act as spares for the different PCBs.</p>
<img src="mcuschematic.png" alt="Common Schematic for STM32F103C8T6" style="max-width: 100%;">
<h5 id="figure-10-common-schematic-for-stm32f103c8t6">Figure 10: Common Schematic for STM32F103C8T6<a hidden class="anchor" aria-hidden="true" href="#figure-10-common-schematic-for-stm32f103c8t6">#</a></h5>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Component</strong></th>
          <th style="text-align: left"><strong>Reason for Selection</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">STM32F103C8T6</td>
          <td style="text-align: left">A widely used microcontroller that is onboard the &ldquo;Blue-Pill&rdquo; development board, ensuring high availability and supply stability.</td>
      </tr>
      <tr>
          <td style="text-align: left">ISOW1044B</td>
          <td style="text-align: left">Combines the isolated regulator and CAN transceiver into one single component, saving space onboard the PCB.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-8-reasons-for-the-components-selected-for-standardisation">Table 8: Reasons for the Components Selected for Standardisation<a hidden class="anchor" aria-hidden="true" href="#table-8-reasons-for-the-components-selected-for-standardisation">#</a></h5>
<hr>
<h2 id="5-system-architecture">5. System Architecture<a hidden class="anchor" aria-hidden="true" href="#5-system-architecture">#</a></h2>
<p>In this section, the summarised power, electrical and connector architectures provide a big picture of the system. This aims to provide a holistic understanding of how the system is structured before delving into the detailed design of the PMB. Subsequent sections will explain how the design choices support the overall project goals.</p>
<p><img loading="lazy" src="powerarch.png" alt="Summarised Power Architecture of PMB"  />
</p>
<h5 id="figure-11-summarised-power-architecture-of-pmb">Figure 11: Summarised Power Architecture of PMB<a hidden class="anchor" aria-hidden="true" href="#figure-11-summarised-power-architecture-of-pmb">#</a></h5>
<p><img loading="lazy" src="commsarch.png" alt="Summarised Communications Architecture of PMB"  />
</p>
<h5 id="figure-12-summarised-communications-architecture-of-pmb">Figure 12: Summarised Communications Architecture of PMB<a hidden class="anchor" aria-hidden="true" href="#figure-12-summarised-communications-architecture-of-pmb">#</a></h5>
<p><img loading="lazy" src="connectors.png" alt="Summarised Connectors Architecture of PMB"  />
</p>
<h5 id="figure-13-summarised-connectors-architecture-of-pmb">Figure 13: Summarised Connectors Architecture of PMB<a hidden class="anchor" aria-hidden="true" href="#figure-13-summarised-connectors-architecture-of-pmb">#</a></h5>
<hr>
<h2 id="6-improving-auv-performance">6. Improving AUV Performance<a hidden class="anchor" aria-hidden="true" href="#6-improving-auv-performance">#</a></h2>
<p>One way to improve the AUV&rsquo;s performance is by extending its run time. This enables longer in-water testing by reducing interruptions due to battery swaps. This supports uninterrupted testing to better simulate longer competition runs. Two methods were implemented to achieve this: renewing the current batteries and introducing accurate state-of-charge (SoC) estimation.</p>
<h3 id="61-battery-renewal">6.1 Battery Renewal<a hidden class="anchor" aria-hidden="true" href="#61-battery-renewal">#</a></h3>
<p>The batteries have been in use for over 2 years, with an estimated 200 cycles completed.</p>
<p><img loading="lazy" src="cyclestats.png" alt="Battery Cycle Life"  />
</p>
<h5 id="figure-14-information-on-the-cycle-life-of-the-current-battery">Figure 14: Information on The Cycle Life of The Current Battery<a hidden class="anchor" aria-hidden="true" href="#figure-14-information-on-the-cycle-life-of-the-current-battery">#</a></h5>
<p>As the current battery hull design is expected to remain in use for several more competition cycles, the batteries should be renewed to avoid more degradation.</p>
<p>Operationally, each AUV requires six batteries, organised into three sets of two: one set in use, one set charging, and one set on standby. Therefore, selecting cost-effective batteries can result in significant savings for the team.</p>
<table>
  <thead>
      <tr>
          <th><strong>Specification</strong></th>
          <th><strong>GrePow LiPo (current)</strong></th>
          <th><strong>Raitan Li-Ion</strong></th>
          <th><strong>MaxAmp Li-Ion</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Configuration</td>
          <td>4S1P</td>
          <td>4S4P</td>
          <td>4S3P</td>
      </tr>
      <tr>
          <td>Fit within the current battery dimensions?</td>
          <td>Yes</td>
          <td>Yes</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>Capacity</td>
          <td>15000mAh</td>
          <td>16000mAh</td>
          <td>15000mAh</td>
      </tr>
      <tr>
          <td>Weight</td>
          <td>1355g</td>
          <td>1200g</td>
          <td>898g</td>
      </tr>
      <tr>
          <td>Maximum Current Draw</td>
          <td>60A</td>
          <td>80A</td>
          <td>75A</td>
      </tr>
      <tr>
          <td>Cost</td>
          <td>SGD 320</td>
          <td>SGD 250</td>
          <td>SGD 451</td>
      </tr>
  </tbody>
</table>
<h5 id="table-9--table-of-comparison-for-batteries">Table 9 : Table of Comparison for Batteries<a hidden class="anchor" aria-hidden="true" href="#table-9--table-of-comparison-for-batteries">#</a></h5>
<p>Lithium-ion batteries were chosen for comparison due to its longer lifespan and higher energy density [3]. With its higher capacity and lower cost, the Raitan Li-Ion battery was selected. Additionally, the team’s prior experience with Raitan provided confidence in the reliability and performance of their product.</p>
<p>Two Raitan Li-Ion batteries were procured for testing and compared with the current batteries.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Specification</strong></th>
          <th style="text-align: left"><strong>GrePow LiPo (current)</strong></th>
          <th style="text-align: left"><strong>Raitan Li-Ion (New)</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Dimensions</td>
          <td style="text-align: left">190mm x 75mm x 42mm</td>
          <td style="text-align: left">171mm x 77mm x 44mm</td>
      </tr>
      <tr>
          <td style="text-align: left">Mass</td>
          <td style="text-align: left">1241g</td>
          <td style="text-align: left">1179g</td>
      </tr>
      <tr>
          <td style="text-align: left">Time taken to draw 7A from fully charged to nominal voltage</td>
          <td style="text-align: left">40 Minutes</td>
          <td style="text-align: left">60 Minutes</td>
      </tr>
  </tbody>
</table>
<h5 id="table-10-comparing-grepow-lipo-batteries-with-raitan-li-ion-batteries">Table 10: Comparing GrePow LiPo Batteries with Raitan Li-Ion Batteries<a hidden class="anchor" aria-hidden="true" href="#table-10-comparing-grepow-lipo-batteries-with-raitan-li-ion-batteries">#</a></h5>
<p><img loading="lazy" src="voltagegraph.png" alt="Plotting Voltage of Battery over Time"  />
</p>
<h5 id="figure-15-voltage-drop-over-time-at-7a-constant-current-draw">Figure 15: Voltage Drop over Time at 7A Constant Current Draw<a hidden class="anchor" aria-hidden="true" href="#figure-15-voltage-drop-over-time-at-7a-constant-current-draw">#</a></h5>
<p><img loading="lazy" src="batteries.jpg" alt="Photo of Grepow Battery (left) and Raitan Li-Ion Battery (Right)"  />
</p>
<h5 id="figure-16-photo-of-grepow-battery-left-and-raitan-li-ion-battery-right">Figure 16: Photo of Grepow Battery (left) and Raitan Li-Ion Battery (Right)<a hidden class="anchor" aria-hidden="true" href="#figure-16-photo-of-grepow-battery-left-and-raitan-li-ion-battery-right">#</a></h5>
<p><img loading="lazy" src="newbatthull.png" alt="Photo of New Batteries in AUV4.1 Battery Hull"  />
</p>
<h5 id="figure-17-photo-of-new-batteries-in-auv41-battery-hull">Figure 17: Photo of New Batteries in AUV4.1 Battery Hull<a hidden class="anchor" aria-hidden="true" href="#figure-17-photo-of-new-batteries-in-auv41-battery-hull">#</a></h5>
<p>Raitan Li-Ion battery has been verified to be comparable to the GrePow LiPo battery making it a suitable replacement for the old batteries.</p>
<h3 id="62-accurate-soc-estimation">6.2 Accurate SoC Estimation<a hidden class="anchor" aria-hidden="true" href="#62-accurate-soc-estimation">#</a></h3>
<p>As mentioned in <a href="#232-limited-capabilities-of-battery-fuel-gauge">Section 2.3.2</a>, the team previously relied on voltage to estimate the battery capacity. This approach tends to end tests prematurely, as conservative voltage thresholds fail to account for load and battery age. By utilising the gauging feature on battery management chip, we can determine a more accurate SoC, allowing in-water tests to run longer without risking battery damage.</p>
<h4 id="621-literature-review">6.2.1 Literature Review<a hidden class="anchor" aria-hidden="true" href="#621-literature-review">#</a></h4>
<p>Looking at RoboSub 2023 and RoboSub 2024 Teams&rsquo; Technical Design Report, only 2 other teams (Cornell University [8] and The Ohio State University [9]) developed a PMB with a battery gauge. The teams used the BQ40Z50 and BQ40Z80 chips from Texas Instruments (TI) respectively.</p>
<h4 id="622-justification-for-chip-selection">6.2.2 Justification for Chip Selection<a hidden class="anchor" aria-hidden="true" href="#622-justification-for-chip-selection">#</a></h4>
<p>Additionally TI, offers extensive community support on its forum and provides numerous resources guiding customers in using its chips (Figure 18, Figure 19, Figure 20).</p>
<p><img loading="lazy" src="forum.png" alt="TI&rsquo;s Forum Search Result"  />
</p>
<h5 id="figure-18-search-results-of-ti-forums">Figure 18: Search Results of TI Forums<a hidden class="anchor" aria-hidden="true" href="#figure-18-search-results-of-ti-forums">#</a></h5>
<p><img loading="lazy" src="youtube.png" alt="TI&rsquo;s YouTube Playlist on Battery Management"  />
</p>
<h5 id="figure-19-tis-youtube-playlist-on-battery-management">Figure 19: TI&rsquo;s YouTube Playlist on Battery Management<a hidden class="anchor" aria-hidden="true" href="#figure-19-tis-youtube-playlist-on-battery-management">#</a></h5>
<p><img loading="lazy" src="bqdocument.png" alt="List of Documents for BQ40Z50"  />
</p>
<h5 id="figure-20-documents-for-bq40z50">Figure 20: Documents for BQ40Z50<a hidden class="anchor" aria-hidden="true" href="#figure-20-documents-for-bq40z50">#</a></h5>
<p>Additionally, its software application &ldquo;bqStudio&rdquo; provides an easy interface with the chip (Figure 21).</p>
<p><img loading="lazy" src="bq.png" alt="Screenshot of bQStudio"  />
</p>
<h5 id="figure-21-screenshot-of-bqstudio">Figure 21: Screenshot of bQStudio<a hidden class="anchor" aria-hidden="true" href="#figure-21-screenshot-of-bqstudio">#</a></h5>
<p>To leverage the extensive resources available and increase likelihood of success, a compatible chip from the TI family was shortlisted. Successful implementations by teams such as Cornell and OSU further validate the chip’s reliability in AUV applications.</p>
<table>
  <thead>
      <tr>
          <th><strong>Feature</strong></th>
          <th><strong>BQ34110 (Current)</strong></th>
          <th><strong>BQ40Z50 (Proposed)</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Battery Gauging Algorithm</td>
          <td>Compensated End-of-Discharge Voltage</td>
          <td>TI’s Impedance Track</td>
      </tr>
      <tr>
          <td>Algorithm Comparison [10]</td>
          <td>- Inaccurate SoC after idle period<br>- Affected by aged battery<br></td>
          <td>- Remains accurate after idle<br>- Resistant to ageing and temperature changes<br>- Remains accurate at high level of discharge.<br> - Lower error rate.</td>
      </tr>
  </tbody>
</table>
<p>BQ40Z50 was chosen as it supports up to 4-Series Li-Ion or LiPo Battery Packs. It also offers programmable protection features (<a href="#82-protection-features">Section 8.2</a>) as well as Impedance Tracking and Cell Balancing. The chip is also able to track the number of cycles the batteries have been through. This reduces the need to guess when the batter capacity falls below a certain amount and hence prepare the operator to procure a new set of batteries. Furthermore, its large number of available stocks (Figure 22) ensures that the PMB can be easily reproduced or repaired in the future if necessary.</p>
<p><img loading="lazy" src="bq40z50mouser.png" alt="BQ40Z50 Availability on Mouser"  />
</p>
<h5 id="figure-22-bq40z50-availability-on-mouser">Figure 22: BQ40Z50 Availability on Mouser<a hidden class="anchor" aria-hidden="true" href="#figure-22-bq40z50-availability-on-mouser">#</a></h5>
<h4 id="623-evaluation-of-soc-accuracy">6.2.3 Evaluation of SoC Accuracy<a hidden class="anchor" aria-hidden="true" href="#623-evaluation-of-soc-accuracy">#</a></h4>
<p>Hence, to evaluate the SoC accuracy, the new Li-Ion battery along with the PMB went through a learning cycle [11].</p>
<p>When discharged at a constant current of 7A, the Voltage and SoC reported by BQ40Z50 was recorded (Table 11). When using the LiPo battery, the team had a threshold of 15.2V (nominal voltage + 0.4V). Based on the chart, this would be roughly at 40% Depth of Discharge (DoD) (Figure 23).</p>
<p><img loading="lazy" src="blog-lipo-battery-voltage-quick-chart.webp" alt="Voltage to Capacity"  />
</p>
<h5 id="figure-23-chart-of-voltage-and-its-corresponding-capacity-2">Figure 23: Chart of Voltage and its Corresponding Capacity [2]<a hidden class="anchor" aria-hidden="true" href="#figure-23-chart-of-voltage-and-its-corresponding-capacity-2">#</a></h5>
<p>If we were to do the same for the Li-Ion battery the threshold would be 14.8V. This would mean that the run would end before 65 minutes. However, by using SoC the vehicle would be able to run to at least 75 minutes, extending the run time by 15.4 %.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>Time (minutes)</strong></th>
          <th style="text-align: center"><strong>Voltage (V)</strong></th>
          <th style="text-align: center"><strong>Relative State of Charge Reported by BQ40Z50</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">0</td>
          <td style="text-align: center">16.5</td>
          <td style="text-align: center">100%</td>
      </tr>
      <tr>
          <td style="text-align: center">10</td>
          <td style="text-align: center">16.03</td>
          <td style="text-align: center">93%</td>
      </tr>
      <tr>
          <td style="text-align: center">20</td>
          <td style="text-align: center">15.91</td>
          <td style="text-align: center">86%</td>
      </tr>
      <tr>
          <td style="text-align: center">30</td>
          <td style="text-align: center">15.45</td>
          <td style="text-align: center">74%</td>
      </tr>
      <tr>
          <td style="text-align: center">45</td>
          <td style="text-align: center">15.18</td>
          <td style="text-align: center">67%</td>
      </tr>
      <tr>
          <td style="text-align: center">55</td>
          <td style="text-align: center">15.94</td>
          <td style="text-align: center">59%</td>
      </tr>
      <tr>
          <td style="text-align: center">65</td>
          <td style="text-align: center">14.68</td>
          <td style="text-align: center">51%</td>
      </tr>
      <tr>
          <td style="text-align: center">75</td>
          <td style="text-align: center">14.4</td>
          <td style="text-align: center">45%</td>
      </tr>
  </tbody>
</table>
<h5 id="table-11-bq40z50-soc-reporting-during-constant-current-discharge">Table 11: BQ40Z50 SoC Reporting During Constant Current Discharge<a hidden class="anchor" aria-hidden="true" href="#table-11-bq40z50-soc-reporting-during-constant-current-discharge">#</a></h5>
<p>The BQ40Z50 is also able to report the time taken to fully charge the batteries, and time taken to fully discharge the batteries. This time is calculated by the average power draw of the batteries.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>Case</strong></th>
          <th style="text-align: center"><strong>Start Time</strong></th>
          <th style="text-align: center"><strong>Starting Battery Voltage and SoC</strong></th>
          <th style="text-align: center"><strong>Predicted End Time</strong></th>
          <th style="text-align: center"><strong>Actual End Time</strong></th>
          <th style="text-align: center"><strong>Time Difference</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">A</td>
          <td style="text-align: center">8:20 PM</td>
          <td style="text-align: center">16.42V, 84%</td>
          <td style="text-align: center">9:30 PM</td>
          <td style="text-align: center">9:10 PM</td>
          <td style="text-align: center">20 mins early</td>
      </tr>
      <tr>
          <td style="text-align: center">B</td>
          <td style="text-align: center">1:07 AM</td>
          <td style="text-align: center">15.76V, 65%</td>
          <td style="text-align: center">3:15 AM</td>
          <td style="text-align: center">2:41 AM</td>
          <td style="text-align: center">34 mins early</td>
      </tr>
  </tbody>
</table>
<h5 id="table-12-battery-charging-time-compared-to-bq40z50-predicted-end-time">Table 12: Battery Charging Time Compared to BQ40Z50 Predicted End Time<a hidden class="anchor" aria-hidden="true" href="#table-12-battery-charging-time-compared-to-bq40z50-predicted-end-time">#</a></h5>
<p>This can be useful as it allows members to better plan and anticipate battery changes at pool tests. While the predicted end time tends to be conservative, this behaviour is preferable as it provides a useful buffer when planning battery swaps.</p>
<hr>
<h2 id="7-enhance-user-operability-and-workflow">7. Enhance User Operability and Workflow<a hidden class="anchor" aria-hidden="true" href="#7-enhance-user-operability-and-workflow">#</a></h2>
<p>One part of the project is to enhance user operability and workflow. User operability can be improved by allowing for easier operation and maintenance of the battery hull, reducing AUV&rsquo;s downtime. Easier maintenance can also help prevent damage to the battery hulls. Improved workflow can help to identify potential issues and allow for early detection of faults. Both user operability and workflow can come together to increase the reliability of the vehicle.</p>
<h3 id="71-in-hull-firmware-flashing">7.1 In-Hull Firmware Flashing<a hidden class="anchor" aria-hidden="true" href="#71-in-hull-firmware-flashing">#</a></h3>
<p>Currently, the microcontroller on the PMB can only be programmed via the exposed Serial Wire Debug (SWD) pins on the PCB inside the battery hull. This process is time-consuming and increases the risk of sealing errors during reassembly. By enabling in-hull firmware flashing, software updates can be performed without physical disassembly, significantly reducing maintenance time and increasing operational efficiency.</p>
<h4 id="711-prior-implementation-robotx-2024">7.1.1 Prior Implementation: RobotX 2024<a hidden class="anchor" aria-hidden="true" href="#711-prior-implementation-robotx-2024">#</a></h4>
<p>In-hull flashing was successfully implemented during RobotX 2024. A USB port was exposed on the side of the hulls onboard the Autonomous Surface Vessel (ASV), allowing members to update the firmware without opening the hull. This cuts down the time required for firmware update from five minutes to one minute.</p>
<p><img loading="lazy" src="hullflashing.jpg" alt="USB Port for Flashing on the ASV"  />
</p>
<h5 id="figure-23-usb-port-for-flashing-on-asv40">Figure 23: USB Port for Flashing on ASV4.0<a hidden class="anchor" aria-hidden="true" href="#figure-23-usb-port-for-flashing-on-asv40">#</a></h5>
<h4 id="712-design-concept-1---firmware-flashing-via-can-bus">7.1.2 Design Concept 1 - Firmware Flashing via CAN Bus<a hidden class="anchor" aria-hidden="true" href="#712-design-concept-1---firmware-flashing-via-can-bus">#</a></h4>
<p>Initially, an option was to use the CAN lines to flash firmware onto the microcontroller.</p>
<p><img loading="lazy" src="battconnector.png" alt="AUV4.1 Battery Hull Power Connector Pinout"  />
</p>
<h5 id="figure-24-auv41-battery-hull-power-connector-pinout">Figure 24: AUV4.1 Battery Hull Power Connector Pinout<a hidden class="anchor" aria-hidden="true" href="#figure-24-auv41-battery-hull-power-connector-pinout">#</a></h5>
<p>However, this option increases complexity of the system as a bootloader has to be written to support the firmware upload over CAN Bus.</p>
<h4 id="713-design-concept-2---repurposing-the-balance-connector">7.1.3 Design Concept 2 - Repurposing the Balance Connector<a hidden class="anchor" aria-hidden="true" href="#713-design-concept-2---repurposing-the-balance-connector">#</a></h4>
<p>An alternate approach is to repurpose the AUV4.1 balance connector, which was originally used to expose the LiPo battery&rsquo;s balance pins for external cell balancing during charging. However, as the BQ40Z50 chip support cell balancing, this connector is now redundant and can be reassigned for other functions.</p>
<p><img loading="lazy" src="oldbal.png" alt="Old Balance Connector Pin Out"  />
</p>
<h5 id="figure-25-old-balance-connector-pin-out">Figure 25: Old Balance Connector Pin Out<a hidden class="anchor" aria-hidden="true" href="#figure-25-old-balance-connector-pin-out">#</a></h5>
<p>The Balance Connector can be re-wired within the battery hull to expose the microcontroller programming pins (SWDIO, SWDCLK, RESET and Ground). Since communication with the BQ40Z50 chip is via SMBus, the SMBus lines (SMBD, SMBC and SMB GND) can also be exposed on the same connector. This allows the user to programme the microcontroller and the BQ40Z50 chip without unsealing the hull, reducing down time. Furthermore, it does not require significant development effort to implement this feature.</p>
<p><img loading="lazy" src="newbal.png" alt="New Balance Connector Pin Out"  />
</p>
<h5 id="figure-26-new-balance-connector-pin-out">Figure 26: New Balance Connector Pin Out<a hidden class="anchor" aria-hidden="true" href="#figure-26-new-balance-connector-pin-out">#</a></h5>
<h3 id="72-remote-status-monitoring">7.2 Remote Status Monitoring<a hidden class="anchor" aria-hidden="true" href="#72-remote-status-monitoring">#</a></h3>
<p>As discussed in in <a href="#233-challenges-with-tracking-battery-hulls-pressure-and-temperature">Section 2.3.3</a>,the team currently relies on manual logging to monitor the battery hull’s internal pressure and temperature. This lack of historical data makes it difficult to determine if there is a slow leak. Furthermore recording key telemetry information such as individual cell voltages, state of health can also be logged to track the degradation of the batteries.</p>
<p>As such, the requirements for the remote status monitoring and its reasoning can be summarised below.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Requirements</strong></th>
          <th style="text-align: left"><strong>Reasoning</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Automated Reporting</td>
          <td style="text-align: left">To avoid human error.</td>
      </tr>
      <tr>
          <td style="text-align: left">Wireless Update Data</td>
          <td style="text-align: left">To avoid unsealing the hull to retrieve the data.</td>
      </tr>
      <tr>
          <td style="text-align: left">Low Barrier of Entry Database</td>
          <td style="text-align: left">As members from different sub-teams have to maintain the Battery Hull, the storage database should be easily accessed and used.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-13-requirements-for-remote-status-monitoring-and-their-justifications">Table 13: Requirements for Remote Status Monitoring and Their Justifications<a hidden class="anchor" aria-hidden="true" href="#table-13-requirements-for-remote-status-monitoring-and-their-justifications">#</a></h5>
<h3 id="721-design-concept-1---microcontroller-with-wireless-capabilities">7.2.1 Design Concept 1 - Microcontroller with Wireless Capabilities<a hidden class="anchor" aria-hidden="true" href="#721-design-concept-1---microcontroller-with-wireless-capabilities">#</a></h3>
<p>The initial design involved using a microcontroller with built-in WiFi capabilities (STM32Wx, Espressif MCUs), allowing it to connect to the internet whenever the battery hull is powered on. However, this approach is not ideal as the PMB is placed within a 3D printed metal hull, which would act as a Faraday cage. This would weaken the WiFi signal leading to unreliable connections.</p>
<p>Given that the battery is already connected to the internet when it is attached to the AUV (Figure 27), wireless capabilities are only necessary when the battery hull is charging in the BCB.</p>
<p><img loading="lazy" src="pmbtointernetauv.png" alt="Diagram of Data Flow from PMB to the Internet"  />
</p>
<h5 id="figure-27-diagram-of-data-flow-from-pmb-to-the-internet">Figure 27: Diagram of Data Flow from PMB to the Internet<a hidden class="anchor" aria-hidden="true" href="#figure-27-diagram-of-data-flow-from-pmb-to-the-internet">#</a></h5>
<h3 id="722-design-concept-2---accompanying-pcb-within-the-battery-charging-box">7.2.2 Design Concept 2 - Accompanying PCB Within the Battery Charging Box<a hidden class="anchor" aria-hidden="true" href="#722-design-concept-2---accompanying-pcb-within-the-battery-charging-box">#</a></h3>
<p>To address these limitations, a revised design places a PCB with wireless capabilities in the BCB. The battery hull connects to the LiPo charger in the BCB via the connector in Figure 24. As such, the CAN Low and CAN High data line are unused during charging. Using this connection, a microcontroller can retrieve data from the PMB when it is charging and upload it online.</p>
<p>Hence the a Battery Telemetry Board (BTB) was designed to reside within the BCB. It uses an Espressif32-DevKitC V4 as it was readily available in the lab. While this would mean an additional component is required to reside within the BCB, it is worthwhile as other features such as <a href="#81-real-time-safety-and-status-notifications">Real-Time Safety and Status Notifications</a> can be implemented on the same Battery Telemetry Board.</p>
<p>They key components of the BTB and its purpose are summarised in the table below:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Key Components</strong></th>
          <th style="text-align: left"><strong>Functions</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Espressif ESP32-DevKitC V4</td>
          <td style="text-align: left">Microcontroller with WiFi capabilities to upload telemetry online.</td>
      </tr>
      <tr>
          <td style="text-align: left">SSD1306</td>
          <td style="text-align: left">Onboard screen to display key information.</td>
      </tr>
      <tr>
          <td style="text-align: left">ISOW1044B</td>
          <td style="text-align: left">Isolated CAN transceiver to allow for CAN communication with the PMB.</td>
      </tr>
      <tr>
          <td style="text-align: left">Buzzer</td>
          <td style="text-align: left">Used to alert user of any potential fault.</td>
      </tr>
      <tr>
          <td style="text-align: left">USB-C Connector &amp; Voltage Regulator</td>
          <td style="text-align: left">To power the board directly from the LiPo charger to simplify integration.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-14-components-and-functions-of-the-battery-telemetry-board-btb">Table 14: Components and Functions of the Battery Telemetry Board (BTB)<a hidden class="anchor" aria-hidden="true" href="#table-14-components-and-functions-of-the-battery-telemetry-board-btb">#</a></h5>
<p><img loading="lazy" src="btpcomponents.png" alt="Labelled Components on BTB"  />
</p>
<h5 id="figure-28-labelled-components-on-btb">Figure 28: Labelled Components on BTB<a hidden class="anchor" aria-hidden="true" href="#figure-28-labelled-components-on-btb">#</a></h5>
<p>BTB Schematics are in Appendix A.</p>
<h3 id="723-data-flow">7.2.3 Data Flow<a hidden class="anchor" aria-hidden="true" href="#723-data-flow">#</a></h3>
<p>The PMB constantly reports telemetry via five CAN Messages. The data sent over the messages includes critical information for fault detection (e.g.: voltage, current, internal pressure and temperature), information that can be useful to track degradation (E.g.: individual cell voltages, state of health) are also sent to be documented. Finally, telemetry data that can help in operational planning such as time to full charge and time to empty is transmitted to support efficient pool test scheduling.</p>
<p><img loading="lazy" src="canmsgs.png" alt="List of CAN Messages"  />
</p>
<h5 id="figure-29-data-flow-from-btb-to-telegram-channel-and-google-sheets">Figure 29: Data Flow from BTB to Telegram Channel and Google Sheets<a hidden class="anchor" aria-hidden="true" href="#figure-29-data-flow-from-btb-to-telegram-channel-and-google-sheets">#</a></h5>
<p>The BTB interprets the CAN messages and packages it to be sent to the Telegram Channel and a Google App Script. The Google App Script will then update the respective Google Sheets based on the PMB ID. The time recorded is obtained via NTP.</p>
<p>Google Sheets was chosen as it has a low barrier of entry, allowing all members to easily access their data. Furthermore, it does not require any additional applications to view the data.</p>
<p><img loading="lazy" src="dataflowbtb.png" alt="Data Flow from BTB to Telegram Channel and Google Sheets"  />
</p>
<h5 id="figure-30-data-flow-from-btb-to-telegram-channel-and-google-sheets">Figure 30: Data Flow from BTB to Telegram Channel and Google Sheets<a hidden class="anchor" aria-hidden="true" href="#figure-30-data-flow-from-btb-to-telegram-channel-and-google-sheets">#</a></h5>
<p><img loading="lazy" src="bcbexcel.png" alt="BCB Google Sheet"  />
</p>
<h5 id="figure-31-data-flow-from-btb-to-telegram-channel-and-google-sheets">Figure 31: Data Flow from BTB to Telegram Channel and Google Sheets<a hidden class="anchor" aria-hidden="true" href="#figure-31-data-flow-from-btb-to-telegram-channel-and-google-sheets">#</a></h5>
<p>To ensure data being published is accurate, there is a time out for all the telemetry received. If the BTP does not receive the same message ID from the same PMB within two times of its reporting frequency, all the data from that PMB is cleared. This ensures that only accurate data is recorded to not pollute the dataset for analysis.</p>
<table>
  <thead>
    <tr>
      <th style="text-align:center;"><strong>Telemetry</strong></th>
      <th style="text-align:center;"><strong>Reported on PMB Screen</strong></th>
      <th style="text-align:center;"><strong>Reported on Telegram Channel</strong></th>
      <th style="text-align:center;"><strong>Recorded on Google Sheet</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>Voltage</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Cell1 Voltage</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Cell2 Voltage</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Cell3 Voltage</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Cell4 Voltage</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Current</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>SoC</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Time to Full</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Average Power</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>State of Health FCC</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Internal Pressure</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Temp Probe 1</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Temp Probe 2</td><td style="background-color:#f8c6c6; text-align:center;">N</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
    <tr><td>Internal Temperature</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td><td style="background-color:#c6f6c3; text-align:center;">Y</td></tr>
  </tbody>
</table>
<h5 id="table-15-summary-of-telemetry-availability-across-interfaces">Table 15: Summary of Telemetry Availability Across Interfaces<a hidden class="anchor" aria-hidden="true" href="#table-15-summary-of-telemetry-availability-across-interfaces">#</a></h5>
<p>Due to limited space on the screen, only high-priority telemetry is shown to avoid clutter. The Telegram channel provides immediate operational updates, while full datasets are continuously uploaded to Google Sheets for future analysis. This tiered reporting strategy balances usability with traceability, ensuring the data remains actionable without overwhelming users.</p>
<hr>
<h2 id="8-improving-safety-and-reliability">8. Improving Safety and Reliability<a hidden class="anchor" aria-hidden="true" href="#8-improving-safety-and-reliability">#</a></h2>
<p>Ensuring safety and reliability of the system requires timely identification and mitigation of faults must be before it damages the system. his section outlines three key strategies: leak detection in the battery hull, robust electrical protection features, and utilising good electrical practises to design a high power PCB.</p>
<h3 id="81-real-time-safety-and-status-notifications">8.1 Real-Time Safety and Status Notifications<a hidden class="anchor" aria-hidden="true" href="#81-real-time-safety-and-status-notifications">#</a></h3>
<p>As mentioned in <a href="#233-challenges-with-tracking-battery-hulls-pressure-and-temperature">Section 2.3.3</a>, slow battery hull leaks are difficult to detect without consistent data. A possible solution will be the automatic notification of team members when a leak is detected by the system.</p>
<h4 id="811-past-experiences">8.1.1 Past Experiences<a hidden class="anchor" aria-hidden="true" href="#811-past-experiences">#</a></h4>
<p>During the testing and development of the Autonomous Surface Vessel, a Telegram Channel was running on the ASV to periodically report the battery voltage and current draw. This proved invaluable as it help the team to anticipate and prepare for battery swaps. Furthermore, it helped the team to identify a load-balancing issue in the vehicle that would have otherwise gone unnoticed.</p>
<p><img loading="lazy" src="tele.png" alt="Telegram Channel Reporting ASV&rsquo;s Battery Status"  />
</p>
<h5 id="figure-32-telegram-channel-reporting-asvs-battery-status">Figure 32: Telegram Channel Reporting ASV&rsquo;s Battery Status<a hidden class="anchor" aria-hidden="true" href="#figure-32-telegram-channel-reporting-asvs-battery-status">#</a></h5>
<h4 id="812-chosen-method">8.1.2 Chosen Method<a hidden class="anchor" aria-hidden="true" href="#812-chosen-method">#</a></h4>
<p>Telegram was selected as the alert platform due to its prior success and team-wide adoption. Furthermore, as it is used for internal communications, it provides a low-barrier of entry and high-visibility for any fault notification.</p>
<h4 id="813-leak-detection-implementation">8.1.3 Leak Detection Implementation<a hidden class="anchor" aria-hidden="true" href="#813-leak-detection-implementation">#</a></h4>
<p>A Google App Script processes data uploaded from the Battery Telemetry Board (BTB) and checks for the following leak indicators:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Condition</strong></th>
          <th style="text-align: left"><strong>Notification</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Internal Pressure Below 107</td>
          <td style="text-align: left">ALERT: PMB IS LEAKING!</td>
      </tr>
      <tr>
          <td style="text-align: left">Drop in the Ratio of Internal Pressure to Temperature &gt; 0.5</td>
          <td style="text-align: left">ALERT: PMB MIGHT BE leaking, please observe.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-16-leak-detection-thresholds-and-corresponding-notifications">Table 16: Leak Detection Thresholds and Corresponding Notifications<a hidden class="anchor" aria-hidden="true" href="#table-16-leak-detection-thresholds-and-corresponding-notifications">#</a></h5>
<p>The leak detection is based on the Gay Lussac&rsquo;s Law [4] which states that the pressure of a gas is directly proportional to its temperature at constant volume. Hence, if the Battery Hull is not leaking, the amount of gas in the hull should remain the same. Thus, the ratio of internal pressure to temperature should remain consistent despite temperature changes. Therefore, a significant deviation in this ratio would suggest a potential leak.</p>
<p>To obtain the previous Internal Pressure to Temperature ratio, the Google App Script obtains the last recorded data for the PMB on the Google Sheet.</p>
<p>The threshold of 0.5 is determined by observing the change in temperature and internal pressure of three battery hulls.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>Pressure</strong></th>
          <th style="text-align: center"><strong>Temp</strong></th>
          <th style="text-align: center"><strong>P/T</strong></th>
          <th style="text-align: center"><strong>P/T Difference</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">110.30</td>
          <td style="text-align: center">24</td>
          <td style="text-align: center">4.596</td>
          <td style="text-align: center">-</td>
      </tr>
      <tr>
          <td style="text-align: center">110.38</td>
          <td style="text-align: center">25</td>
          <td style="text-align: center">4.415</td>
          <td style="text-align: center">-0.181</td>
      </tr>
      <tr>
          <td style="text-align: center">110.45</td>
          <td style="text-align: center">27</td>
          <td style="text-align: center">4.091</td>
          <td style="text-align: center">-0.324</td>
      </tr>
      <tr>
          <td style="text-align: center">110.52</td>
          <td style="text-align: center">27</td>
          <td style="text-align: center">4.093</td>
          <td style="text-align: center">0.003</td>
      </tr>
      <tr>
          <td style="text-align: center">110.58</td>
          <td style="text-align: center">27</td>
          <td style="text-align: center">4.096</td>
          <td style="text-align: center">0.002</td>
      </tr>
      <tr>
          <td style="text-align: center">110.71</td>
          <td style="text-align: center">28</td>
          <td style="text-align: center">3.954</td>
          <td style="text-align: center">-0.142</td>
      </tr>
      <tr>
          <td style="text-align: center">110.80</td>
          <td style="text-align: center">28</td>
          <td style="text-align: center">3.957</td>
          <td style="text-align: center">0.003</td>
      </tr>
      <tr>
          <td style="text-align: center">110.85</td>
          <td style="text-align: center">28</td>
          <td style="text-align: center">3.959</td>
          <td style="text-align: center">0.002</td>
      </tr>
  </tbody>
</table>
<h5 id="table-17-changes-in-pressure-and-temperature-of-battery-hull-a">Table 17: Changes in Pressure and Temperature of Battery Hull A<a hidden class="anchor" aria-hidden="true" href="#table-17-changes-in-pressure-and-temperature-of-battery-hull-a">#</a></h5>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>Pressure</strong></th>
          <th style="text-align: center"><strong>Temp</strong></th>
          <th style="text-align: center"><strong>P/T</strong></th>
          <th style="text-align: center"><strong>P/T Difference</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">112.49</td>
          <td style="text-align: center">24</td>
          <td style="text-align: center">4.687</td>
          <td style="text-align: center">-</td>
      </tr>
      <tr>
          <td style="text-align: center">112.54</td>
          <td style="text-align: center">24</td>
          <td style="text-align: center">4.689</td>
          <td style="text-align: center">0.002</td>
      </tr>
      <tr>
          <td style="text-align: center">112.59</td>
          <td style="text-align: center">25</td>
          <td style="text-align: center">4.504</td>
          <td style="text-align: center">-0.186</td>
      </tr>
      <tr>
          <td style="text-align: center">112.63</td>
          <td style="text-align: center">25</td>
          <td style="text-align: center">4.506</td>
          <td style="text-align: center">0.002</td>
      </tr>
      <tr>
          <td style="text-align: center">112.67</td>
          <td style="text-align: center">25</td>
          <td style="text-align: center">4.507</td>
          <td style="text-align: center">0.002</td>
      </tr>
      <tr>
          <td style="text-align: center">112.75</td>
          <td style="text-align: center">25</td>
          <td style="text-align: center">4.510</td>
          <td style="text-align: center">0.003</td>
      </tr>
      <tr>
          <td style="text-align: center">112.80</td>
          <td style="text-align: center">25</td>
          <td style="text-align: center">4.512</td>
          <td style="text-align: center">0.002</td>
      </tr>
      <tr>
          <td style="text-align: center">112.85</td>
          <td style="text-align: center">26</td>
          <td style="text-align: center">4.340</td>
          <td style="text-align: center">-0.172</td>
      </tr>
  </tbody>
</table>
<h5 id="table-18-changes-in-pressure-and-temperature-of-battery-hull-b">Table 18: Changes in Pressure and Temperature of Battery Hull B<a hidden class="anchor" aria-hidden="true" href="#table-18-changes-in-pressure-and-temperature-of-battery-hull-b">#</a></h5>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>Pressure</strong></th>
          <th style="text-align: center"><strong>Temp</strong></th>
          <th style="text-align: center"><strong>P/T</strong></th>
          <th style="text-align: center"><strong>P/T Difference</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">111.88</td>
          <td style="text-align: center">24</td>
          <td style="text-align: center">4.662</td>
          <td style="text-align: center">-</td>
      </tr>
      <tr>
          <td style="text-align: center">112.04</td>
          <td style="text-align: center">26</td>
          <td style="text-align: center">4.309</td>
          <td style="text-align: center">-0.352</td>
      </tr>
      <tr>
          <td style="text-align: center">112.10</td>
          <td style="text-align: center">28</td>
          <td style="text-align: center">4.004</td>
          <td style="text-align: center">-0.306</td>
      </tr>
      <tr>
          <td style="text-align: center">112.16</td>
          <td style="text-align: center">28</td>
          <td style="text-align: center">4.006</td>
          <td style="text-align: center">0.002</td>
      </tr>
      <tr>
          <td style="text-align: center">112.23</td>
          <td style="text-align: center">29</td>
          <td style="text-align: center">3.870</td>
          <td style="text-align: center">-0.136</td>
      </tr>
      <tr>
          <td style="text-align: center">112.34</td>
          <td style="text-align: center">29</td>
          <td style="text-align: center">3.874</td>
          <td style="text-align: center">0.004</td>
      </tr>
      <tr>
          <td style="text-align: center">112.43</td>
          <td style="text-align: center">29</td>
          <td style="text-align: center">3.877</td>
          <td style="text-align: center">0.003</td>
      </tr>
      <tr>
          <td style="text-align: center">112.47</td>
          <td style="text-align: center">30</td>
          <td style="text-align: center">3.749</td>
          <td style="text-align: center">-0.128</td>
      </tr>
  </tbody>
</table>
<h5 id="table-19-changes-in-pressure-and-temperature-of-battery-hull-b">Table 19: Changes in Pressure and Temperature of Battery Hull B<a hidden class="anchor" aria-hidden="true" href="#table-19-changes-in-pressure-and-temperature-of-battery-hull-b">#</a></h5>
<p>By feeding various data to the BTB, we are able to simulate a leaking hull, leading to an alert sent to the Telegram Channel.</p>
<p><img loading="lazy" src="ratio.png" alt="Telegram Channel Reporting a Possible Leak"  />
</p>
<h5 id="figure-33-telegram-channel-reporting-a-possible-leak-in-pmb2">Figure 33: Telegram Channel Reporting a Possible Leak in PMB2<a hidden class="anchor" aria-hidden="true" href="#figure-33-telegram-channel-reporting-a-possible-leak-in-pmb2">#</a></h5>
<p><img loading="lazy" src="leak.png" alt="Telegram Channel Reporting a Leak"  />
</p>
<h5 id="figure-34-telegram-channel-reporting-a-leak-in-pmb1">Figure 34: Telegram Channel Reporting a Leak in PMB1<a hidden class="anchor" aria-hidden="true" href="#figure-34-telegram-channel-reporting-a-leak-in-pmb1">#</a></h5>
<p>The same Telegram channel is also used to broadcast the progress of the battery charging and notifies members when it is fully charged. This feature addresses a common operational issue, where team members may
forget to turn off the charger, especially after fatigue from a long day of pool tests. By receiving timely reminders, the team can ensure a safer operation by turning off the charger when the battery is fully charged.</p>
<p><img loading="lazy" src="teletelem.png" alt="Telegram Channel Reporting Charged Battery"  />
</p>
<h5 id="figure-35-telegram-channel-reporting-a-fully-charged-pmb1">Figure 35: Telegram Channel Reporting a Fully Charged PMB1<a hidden class="anchor" aria-hidden="true" href="#figure-35-telegram-channel-reporting-a-fully-charged-pmb1">#</a></h5>
<h3 id="82-protection-features">8.2 Protection Features<a hidden class="anchor" aria-hidden="true" href="#82-protection-features">#</a></h3>
<p>BQ40Z50 comprises of various protection features. This includes two tiers of protection. The first tier disconnect the circuits via MOSFETs, while the second tier permanently disable the battery pack by blowing the fuse.  Within the first tier there are also hardware protections that can be configured for faster a response from the chip.</p>
<p>These features collectively protect the vehicle from electrical fault, improving the reliability of the system.</p>
<p><img loading="lazy" src="protection.png" alt="Using bQStudio to configure Protection Settings"  />
</p>
<h5 id="figure-36-configuring-bq40z50-protection-parameters-in-bqstudio">Figure 36: Configuring BQ40Z50 Protection Parameters in bqStudio<a hidden class="anchor" aria-hidden="true" href="#figure-36-configuring-bq40z50-protection-parameters-in-bqstudio">#</a></h5>
<p>Several key safety features were configured and tested:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Feature</strong></th>
          <th style="text-align: left"><strong>Test Result</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Overcurrent in Discharge (OCD)</td>
          <td style="text-align: left">Used a load tester to verify that discharging above the set current value for the specified time would turn off the discharge MOSFET.</td>
      </tr>
      <tr>
          <td style="text-align: left">Overload in Discharge Protection (AOLD)</td>
          <td style="text-align: left">Almost instantaneous cut off when discharging above the set current limit.</td>
      </tr>
      <tr>
          <td style="text-align: left">Over Charging Current Protection (OCC)</td>
          <td style="text-align: left">When the charging current is higher than the preset threshold, the Charging MOSFET is turned off.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-20-using-bqstudio-to-configure-protection-settings">Table 20: Using bQStudio to configure Protection Settings<a hidden class="anchor" aria-hidden="true" href="#table-20-using-bqstudio-to-configure-protection-settings">#</a></h5>
<p>Additionally, there is a secondary overvoltage protection chip (BQ294701) monitors cell voltages independently and can also activate the fuse if an overvoltage is detected. This act as a fall back if the BQ40Z50 is malfunctioning.</p>
<h3 id="83-pmb-pcb-design">8.3 PMB PCB Design<a hidden class="anchor" aria-hidden="true" href="#83-pmb-pcb-design">#</a></h3>
<p>To ensure that the PMB is reliable, good PCB design practices  must be followed to ensure both signal integrity and that the PMB can support the power required. The PMB design adheres to recommendations from TI&rsquo;s SLUA660A Advanced Gas Gauge Circuit Design document [5], ensuring proper layout and component interfacing.</p>
<p>The PMB is a 4-Layer PCB with signal routing on the outer layers and dedicated internal planes for power and ground. (<a href="#appendix-b-individual-layers-of-power-monitoring-board">Appendix B</a>)</p>
<p>To remain backwards compatible, the PMB has the same dimensions and connector layout as its predecessor.</p>
<h4 id="831-design-for-high-power-handling">8.3.1 Design for High Power Handling<a hidden class="anchor" aria-hidden="true" href="#831-design-for-high-power-handling">#</a></h4>
<p>The PMB is designed to handle 40A of continuous current. Hence, 2oz copper was used on the outer layers of the PCB, where the power path are, to reduce temperature rise. The traces are also made as wide as possible to reduce resistance.</p>
<p><img loading="lazy" src="3dpower.png" alt="3D Model of Power Path"  />
</p>
<h5 id="figure-37-3d-model-of-power-path">Figure 37: 3D Model of Power Path<a hidden class="anchor" aria-hidden="true" href="#figure-37-3d-model-of-power-path">#</a></h5>
<p><img loading="lazy" src="toppower.png" alt="Power Path on the Top Layer"  />
</p>
<h5 id="figure-38-power-path-on-the-top-layer">Figure 38: Power Path on the Top Layer<a hidden class="anchor" aria-hidden="true" href="#figure-38-power-path-on-the-top-layer">#</a></h5>
<p>The IPTC014N10NM5 MOSFET was chosen as it has a top side cooling package. This allows the use of thermal pad to conduct the heat from the MOSFET to the top of the battery hull [6].</p>
<p><img loading="lazy" src="pcbmosfet.png" alt="MOSFET Highlighted on The New PMB"  />
</p>
<h5 id="figure-39-mosfet-highlighted-on-the-new-pmb">Figure 39: MOSFET Highlighted on The New PMB<a hidden class="anchor" aria-hidden="true" href="#figure-39-mosfet-highlighted-on-the-new-pmb">#</a></h5>
<p>A test was conducted to compare the new MOSFET with the old MOSFET and it&rsquo;s thermal conducting capabilities. The PMB is placed Within the enclosed battery hull with starting temperature of 28 Celsius. A continuous current draw of 40A was carried out for 10 minutes. A thermal camera was then use to measure the temperature of the PCB.</p>
<p><img loading="lazy" src="newpmbthermal.jpg" alt="Thermal Image of the New PMB"  />
</p>
<h5 id="figure-40-thermal-image-of-the-new-pmb-after-load-test">Figure 40: Thermal Image of the New PMB after Load Test<a hidden class="anchor" aria-hidden="true" href="#figure-40-thermal-image-of-the-new-pmb-after-load-test">#</a></h5>
<p><img loading="lazy" src="thermaloldpmb.jpg" alt="Thermal Image of the Old PMB"  />
</p>
<h5 id="figure-41-thermal-image-of-the-old-pmb-after-load-test">Figure 41: Thermal Image of the Old PMB after Load Test<a hidden class="anchor" aria-hidden="true" href="#figure-41-thermal-image-of-the-old-pmb-after-load-test">#</a></h5>
<p>It can be observed that the old PMB has a higher temperature after the load test, indicating that the MOSFETs on the new PMB are better at conducting thermal heat away.</p>
<p>To ensure reliable power supply, a power consumption chart was drawn up to verify that the selected voltage regulator are able to supply enough power.</p>
<p><img loading="lazy" src="pmbpowerconsume.png" alt="PMB&rsquo;s Power Consumption Chart"  />
</p>
<h5 id="figure-42-pmbs-power-consumption-chart">Figure 42: PMB&rsquo;s Power Consumption Chart<a hidden class="anchor" aria-hidden="true" href="#figure-42-pmbs-power-consumption-chart">#</a></h5>
<h4 id="832-design-for-signal-integrity">8.3.2 Design for Signal Integrity<a hidden class="anchor" aria-hidden="true" href="#832-design-for-signal-integrity">#</a></h4>
<p>Ensuring that the signals transmitted on the data lines are not affected by noise are critical to creating a reliable PMB.</p>
<p>Firstly, the board was split into high-power and low-power zones to minimise interference.</p>
<p><img loading="lazy" src="highlowsplit.png" alt="Split between Higher and Lower Power Section of the PMB"  />
</p>
<h5 id="figure-43-split-between-higher-and-lower-power-sections-of-the-pmb-red-line-divides-the-sections">Figure 43: Split between Higher and Lower Power Sections of the PMB (Red Line Divides the Sections)<a hidden class="anchor" aria-hidden="true" href="#figure-43-split-between-higher-and-lower-power-sections-of-the-pmb-red-line-divides-the-sections">#</a></h5>
<p>Due to the variation in current drawn from the battery, it is likely that there would be noise if the low power components were powered from the same source. Hence, an Isolated DC-DC regulator was used to isolate the Battery and AUV power from the microcontroller&rsquo;s components. A low-droput regulator (LDO) was used to step down 3.3V for 3.3V components.</p>
<p>The BQ40Z50 communicates via SMBus, which crosses between the high and lower power sections. Therefore an I2C isolator is used. To protect the SMBus lines from electrostatic discharge and voltage spikes, TVS and Zener diodes are connected to the lines</p>
<p>The various Power and Nets are summarised in the table below:</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Power and Ground Nets</strong></th>
          <th style="text-align: left"><strong>Description</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">+3V3, +5, GND</td>
          <td style="text-align: left">Isolated power and ground to power the components associated with the microcontroller.</td>
      </tr>
      <tr>
          <td style="text-align: left">Batt_Pos, Batt_Neg</td>
          <td style="text-align: left">Positive and negative input from the battery.</td>
      </tr>
      <tr>
          <td style="text-align: left">AUV_Pos, +3V3_UnIso, AUV_Neg</td>
          <td style="text-align: left">Positive and negative output to the AUV, and a 3V3 that references the AUV_Neg.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-21-table-of-power-and-ground-nets-with-its-description">Table 21: Table of Power and Ground Nets with Its Description<a hidden class="anchor" aria-hidden="true" href="#table-21-table-of-power-and-ground-nets-with-its-description">#</a></h5>
<p>This can be further seen in the division of the Power and Ground Plane within the PMB.</p>
<p><img loading="lazy" src="pcbpowerplane.png" alt="PMB Power Plane"  />
</p>
<h5 id="figure-44-pmb-power-plane">Figure 44: PMB Power Plane<a hidden class="anchor" aria-hidden="true" href="#figure-44-pmb-power-plane">#</a></h5>
<p><img loading="lazy" src="pmbgndplane.png" alt="PMB Ground Plane"  />
</p>
<h5 id="figure-45-pmb-ground-plane">Figure 45: PMB Ground Plane<a hidden class="anchor" aria-hidden="true" href="#figure-45-pmb-ground-plane">#</a></h5>
<h4 id="834-user-interface">8.3.4 User Interface<a hidden class="anchor" aria-hidden="true" href="#834-user-interface">#</a></h4>
<p>The PMB uses reed-switches and latching relay to allow the battery to be turned on or off without unsealing the hull. To turn off the system, the MCU Checks for a HIGH signal from the &ldquo;OFF&rdquo; reed switch, ensuring that the relay is only reset after tasks are safely concluded. This would be critical to prevent file corruption if onboard logging is implemented.</p>
<p><img loading="lazy" src="relaycircuit.png" alt="Relay Circuit on The PMB"  />
</p>
<h5 id="figure-46-relay-circuit-on-the-pmb">Figure 46: Relay Circuit on The PMB<a hidden class="anchor" aria-hidden="true" href="#figure-46-relay-circuit-on-the-pmb">#</a></h5>
<p>Key telemetry information being displayed on the screen can also alert users immediately to any potential issues within the battery hull.</p>
<p><img loading="lazy" src="telemandreed.jpg" alt="Telemetry Display and Reed Switches for The Battery Hull"  />
</p>
<h5 id="figure-47-telemetry-display-and-reed-switches-for-the-battery-hull">Figure 47: Telemetry Display and Reed Switches for The Battery Hull<a hidden class="anchor" aria-hidden="true" href="#figure-47-telemetry-display-and-reed-switches-for-the-battery-hull">#</a></h5>
<p>The final layout and assembled PCB are shown below.</p>
<p><img loading="lazy" src="pmbtop.png" alt="PMB Top View"  />
</p>
<h5 id="figure-48-top-view-of-pmb">Figure 48: Top View of PMB<a hidden class="anchor" aria-hidden="true" href="#figure-48-top-view-of-pmb">#</a></h5>
<p><img loading="lazy" src="pmbbottom.png" alt="PMB Bottom View"  />
</p>
<h5 id="figure-49-bottom-view-of-pmb">Figure 49: Bottom View of PMB<a hidden class="anchor" aria-hidden="true" href="#figure-49-bottom-view-of-pmb">#</a></h5>
<hr>
<h2 id="9-system-evaluation">9. System Evaluation<a hidden class="anchor" aria-hidden="true" href="#9-system-evaluation">#</a></h2>
<p>The new design is able to meet the functional requirements stated in <a href="#4-design-considerations">Section 4</a>.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Requirements</strong></th>
          <th style="text-align: center"><strong>Achieved</strong></th>
          <th style="text-align: left"><strong>Description</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Backward Compatible</td>
          <td style="text-align: center">Yes</td>
          <td style="text-align: left">The battery and PMB fit within the previous battery hull and use the existing connectors.</td>
      </tr>
      <tr>
          <td style="text-align: left">Voltage Output</td>
          <td style="text-align: center">Yes</td>
          <td style="text-align: left">A 4S Li-Ion battery was used.</td>
      </tr>
      <tr>
          <td style="text-align: left">Continuous Current</td>
          <td style="text-align: center">Yes</td>
          <td style="text-align: left">Tested that the board is able to draw 40A for 10 minutes.</td>
      </tr>
      <tr>
          <td style="text-align: left">Telemetry</td>
          <td style="text-align: center">Yes</td>
          <td style="text-align: left">Voltage, current, and internal pressure are displayed on the telemetry screen. Voltage was verified with a multimeter; current was calibrated using a load tester.</td>
      </tr>
      <tr>
          <td style="text-align: left">Charging</td>
          <td style="text-align: center">Yes</td>
          <td style="text-align: left">Able to charge the battery.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-22-comparison-between-functional-requirements-and-its-status">Table 22: Comparison between Functional Requirements and Its Status<a hidden class="anchor" aria-hidden="true" href="#table-22-comparison-between-functional-requirements-and-its-status">#</a></h5>
<p>The sub goals set out in <a href="#3-project-goal">Section 3</a> has been met.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>Sub Goals</strong></th>
          <th style="text-align: left"><strong>Implementation</strong></th>
          <th style="text-align: left"><strong>Improvements</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">Enhance User Operability and Work Flow</td>
          <td style="text-align: left">- In-hull firmware update via balance connector<br>- Remote status monitoring via Battery Telemetry Board</td>
          <td style="text-align: left">- Firmware update time reduced from 25 minutes to 3 minutes.<br>- Members can track charging status and refer to historical battery data.</td>
      </tr>
      <tr>
          <td style="text-align: left">Improve Safety and Reliability</td>
          <td style="text-align: left">- Real-time safety and status notification via Telegram<br>- Protection features with BQ40Z50</td>
          <td style="text-align: left">- Immediate alerts when faults are detected.<br>- AUV electrical system is protected from potential electrical faults.</td>
      </tr>
      <tr>
          <td style="text-align: left">Improve AUV Performance</td>
          <td style="text-align: left">- New Li-Ion batteries<br>- Accurate SoC estimation with BQ40Z50</td>
          <td style="text-align: left">- In-water testing time can be extended.</td>
      </tr>
  </tbody>
</table>
<h5 id="table-23-summary-of-sub-goals-and-its-implementation-and-improvements">Table 23: Summary of Sub Goals and Its Implementation and Improvements<a hidden class="anchor" aria-hidden="true" href="#table-23-summary-of-sub-goals-and-its-implementation-and-improvements">#</a></h5>
<p>Unfortunately, there were also mistakes when designing the PCBs that have to be rectified when testing.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center"><strong>PCB</strong></th>
          <th style="text-align: left"><strong>Mistake</strong></th>
          <th style="text-align: left"><strong>Problems</strong></th>
          <th style="text-align: left"><strong>Current Fix</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">PMB</td>
          <td style="text-align: left">No pull-up resistor on the I2C lines between the MCU, screen, and pressure sensor</td>
          <td style="text-align: left">Unable to establish communications on I2C lines</td>
          <td style="text-align: left">Pull-up resistor soldered onto the board</td>
      </tr>
      <tr>
          <td style="text-align: center">PMB</td>
          <td style="text-align: left">No pull-down resistor for the signal from the MCU to reset the reed switch</td>
          <td style="text-align: left">Relay would be reset when the MCU is powered on, leading to the power being cut</td>
          <td style="text-align: left">Pull-down resistor soldered onto the board</td>
      </tr>
      <tr>
          <td style="text-align: center">BTB</td>
          <td style="text-align: left">Resistors from the CC lines on the USB-C connector are pulled up instead of down</td>
          <td style="text-align: left">USB-C would not negotiate properly for power delivery</td>
          <td style="text-align: left">Existing resistor removed and new resistor soldered to pull CC lines to ground</td>
      </tr>
  </tbody>
</table>
<h5 id="table-24-summary-of-pcb-mistakes-and-its-fixes">Table 24: Summary of PCB Mistakes and Its Fixes<a hidden class="anchor" aria-hidden="true" href="#table-24-summary-of-pcb-mistakes-and-its-fixes">#</a></h5>
<p><img loading="lazy" src="pmbfix.png" alt="PMB Fix"  />
</p>
<h5 id="figure-50-soldering-pull-down-resistor-on-pmb">Figure 50: Soldering Pull Down Resistor on PMB<a hidden class="anchor" aria-hidden="true" href="#figure-50-soldering-pull-down-resistor-on-pmb">#</a></h5>
<p><img loading="lazy" src="btpfix.png" alt="BTB Fix"  />
</p>
<h5 id="figure-51-soldering-pull-down-resistor-on-btb">Figure 51: Soldering Pull Down Resistor on BTB<a hidden class="anchor" aria-hidden="true" href="#figure-51-soldering-pull-down-resistor-on-btb">#</a></h5>
<p>The integration of SoC tracking, protection features and remote status monitoring redefines the PMB from being a passive Power Monitoring Board to a Power Management Board. Furthermore, the addition of a BTB to the BCB provides an integrated system to monitor and alert operators of potential faults within the AUV&rsquo;s battery system.</p>
<p>Designed with backward and forward compatibility in mind, the new system is built to support current and future AUV platforms. This implementation enhance safety, usability and reliability, putting the team in a This changes being done while keeping in mind of backwards and forwards compatibility, positions the team for continued success at RoboSub.</p>
<hr>
<h2 id="11-impact-and-future-work">11. Impact and Future Work<a hidden class="anchor" aria-hidden="true" href="#11-impact-and-future-work">#</a></h2>
<p>Due to limited availability of serviceable battery hulls and competing  priorities during pool test, the new battery system has not been tested in-water with the AUV. Hence, testing with the AUV should be done to fully validate the entire system under actual operating conditions.</p>
<p>The BQ40Z50 supports communication of target charging voltage and  current via SMBus. This opens the opportunity to develop a custom charger that interfaces directly with the battery pack, enabling smart charge regulation. The BTP can be integrated with the custom charger to report the charging status.</p>
<p>One usability issue identified relates to connector reuse. In an effort to minimise modifications to the existing battery hull, identical connectors were used for both battery balance lines and microcontroller programming pins. This design choice introduces the risk of incorrect connections during assembly, which could damage the microcontroller. While backward compatibility was prioritised, minor modifications should still be made when necessary to prevent user error and enhance system robustness.</p>
<p>If no major issues are discovered during pool testing, the PMB will be deployed at RoboSub 2025 and RoboSub 2026 across the AUVs fielded by BBAS. Furthermore, with BBAS releasing our PCB schematics online, the PMB can serve as a reference to other AUV teams working on battery management systems. Notably, no internet-connected charging system were observed at RoboSub 2023. By demonstrating this feature at RoboSub 2025, BBAS can inspire other teams to implement remote monitoring for their systems.</p>
<hr>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<ol>
<li>Texas Instruments, “bq34110 Multi-Chemistry CEDV Battery Gas Gauge for Rarely Discharged Applications,” bq34110 datasheet, Aug. 2015 [Revised Nov. 2016]</li>
<li>“Complete Guide to Lipo Battery Voltage,” Ufine Battery [Official], <a href="https://www.ufinebattery.com/blog/useful-overview-of-lipo-battery-voltage/" target="_blank">https://www.ufinebattery.com/blog/useful-overview-of-lipo-battery-voltage/</a> (accessed Apr. 2, 2025).</li>
<li>“LiPo vs Lithium Ion Batteries for Unmanned &amp; Robotics Applications | Unmanned Systems Technology,” Unmanned Systems Technology, Jan. 26, 2023. <a href="https://www.unmannedsystemstechnology.com/feature/lipo-vs-lithium-ion-batteries-for-unmanned-robotics-applications/" target="_blank">https://www.unmannedsystemstechnology.com/feature/lipo-vs-lithium-ion-batteries-for-unmanned-robotics-applications/</a></li>
<li>“Gas Laws,” Gas laws, <a href="https://www.chem.fsu.edu/chemlab/chm1045/gas_laws.html" target="_blank">https://www.chem.fsu.edu/chemlab/chm1045/gas_laws.html</a> (accessed Apr. 2, 2025).</li>
<li>Texas Instruments, “bq40z50 Advanced Gas Gauge Circuit Design,” Application Report, Nov. 2012 [Revised Sep. 2014]</li>
<li>Infineon, &ldquo;Recommendations for Board Assembly of Infineon Packages with Dual Row Gullwing Leads,&rdquo; Nov 2020</li>
<li>“Subconn low profile - 9 contacts,” Underwater Technology, <a href="https://www.macartney.com/connectivity/subconn/subconn-low-profile-series/subconn-low-profile-9-contacts/" target="_blank">https://www.macartney.com/connectivity/subconn/subconn-low-profile-series/subconn-low-profile-9-contacts/</a> (accessed Apr. 2, 2025).</li>
<li>A. Fink et al., &ldquo;Design, Implementation, and Strategy of the Polaris and Sirius AUVs,&rdquo; Cornell Univ. Autonomous Underwater Vehicles, Tech. Rep., Jul. 2024. [Online]. Available: <a href="https://robonation.org/app/uploads/sites/4/2024/07/RS24_TDR_Cornell-compressed.pdf" target="_blank">https://robonation.org/app/uploads/sites/4/2024/07/RS24_TDR_Cornell-compressed.pdf</a></li>
<li>[1] N. Becker, A. Dellacqua, B. Knutson, M. Oinonen, R. Pafford, and C. Tucker, &ldquo;Design Review of Talos: An Autonomous Underwater Vehicle by The Ohio State University’s Underwater Robotics Team,&rdquo; The Ohio State Univ., Tech. Rep., Jun. 2023. [Online]. Available: <a href="https://robonation.org/app/uploads/sites/4/2023/06/TDR_THEOhioStateUniversity_RS2023-compressed.pdf" target="_blank">https://robonation.org/app/uploads/sites/4/2023/06/TDR_THEOhioStateUniversity_RS2023-compressed.pdf</a></li>
<li>Texas Instruments, “Battery Gauging Algorithm Comparison,” Application Report, Dec. 2023</li>
<li>Texas Instruments, “Achieving The Successful Learning Cycle,” Application Report, Jul. 2018</li>
</ol>
<hr>
<h2 id="appendix-a-pcb-schematics">Appendix A: PCB Schematics<a hidden class="anchor" aria-hidden="true" href="#appendix-a-pcb-schematics">#</a></h2>
<ul>
<li><a href="PMB4.5-2Schematics.pdf">Power Monitoring Board Schematic</a></li>
<li><a href="btpschematic.pdf">Battery Telemetry Board Schematic</a></li>
</ul>
<h2 id="appendix-b-individual-layers-of-power-monitoring-board">Appendix B: Individual Layers of Power Monitoring Board<a hidden class="anchor" aria-hidden="true" href="#appendix-b-individual-layers-of-power-monitoring-board">#</a></h2>
<p><img loading="lazy" src="pmbtoponly.png" alt="PMB Top Layer"  />
</p>
<h5 id="top-layer-of-pmb">Top Layer of PMB<a hidden class="anchor" aria-hidden="true" href="#top-layer-of-pmb">#</a></h5>
<p><img loading="lazy" src="pmbpwronly.png" alt="PMB Power Plane"  />
</p>
<h5 id="power-plane-of-pmb">Power Plane of PMB<a hidden class="anchor" aria-hidden="true" href="#power-plane-of-pmb">#</a></h5>
<p><img loading="lazy" src="pmbgndonly.png" alt="PMB Ground Plane"  />
</p>
<h5 id="ground-plane-of-pmb">Ground Plane of PMB<a hidden class="anchor" aria-hidden="true" href="#ground-plane-of-pmb">#</a></h5>
<p><img loading="lazy" src="pmbbottomonly.png" alt="PMB Bottom Layer"  />
</p>
<h5 id="bottom-layer-of-pmb">Bottom Layer of PMB<a hidden class="anchor" aria-hidden="true" href="#bottom-layer-of-pmb">#</a></h5>
<h2 id="appendix-c-relay-circuit-calculation">Appendix C: Relay Circuit Calculation<a hidden class="anchor" aria-hidden="true" href="#appendix-c-relay-circuit-calculation">#</a></h2>
<p><img loading="lazy" src="relaycircuitcalc.png" alt="Relay Circuit Calculation"  />
</p>
<h5 id="relay-circuit-calculation">Relay Circuit Calculation<a hidden class="anchor" aria-hidden="true" href="#relay-circuit-calculation">#</a></h5>
<h2 id="appendix-d-battery-specification">Appendix D: Battery Specification<a hidden class="anchor" aria-hidden="true" href="#appendix-d-battery-specification">#</a></h2>
<ul>
<li><a href="lipobatt.pdf">AUV4.1 LiPo Battery</a></li>
<li><a href="liionbatt.pdf">AUV4.5 Li-Ion Battery</a></li>
</ul>
<h2 id="appendix-e-3d-model-of-auv45-power-monitoring-board">Appendix E: 3D Model of AUV4.5 Power Monitoring Board<a hidden class="anchor" aria-hidden="true" href="#appendix-e-3d-model-of-auv45-power-monitoring-board">#</a></h2>
<div style="display: flex; justify-content: center;">
  <div class="sketchfab-embed-wrapper" style="width: 100%; max-width: 900px;">
    <iframe title="AUV4.5 Power Monitoring Board 3D Model"
            frameborder="0"
            allowfullscreen
            mozallowfullscreen="true"
            webkitallowfullscreen="true"
            allow="autoplay; fullscreen; xr-spatial-tracking"
            xr-spatial-tracking
            execution-while-out-of-viewport
            execution-while-not-rendered
            web-share
            style="width: 100%; height: 480px;"
            src="https://sketchfab.com/models/1ba9f9a1e7d0487896ffd8acb5602e95/embed">
    </iframe>
    <p style="font-size: 13px; font-weight: normal; margin: 5px; color: #4A4A4A; text-align: center;">
      <a href="https://sketchfab.com/3d-models/step-no-variations-for-auv4-5-2-pmb-pcbdoc-1ba9f9a1e7d0487896ffd8acb5602e95?utm_medium=embed&utm_campaign=share-popup&utm_content=1ba9f9a1e7d0487896ffd8acb5602e95"
         target="_blank"
         rel="nofollow"
         style="font-weight: bold; color:black;">
        AUV4.5 Power Management Board 3D Model
      </a>
    </p>
  </div>
</div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="http://localhost:1313/website/">AUV Battery Management System</a></span> ·     
    <span>
    Powered by 
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/pmichaillat/hugo-website/" rel="noopener" target="_blank">a modified version</a>
         of 
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>
</html>
